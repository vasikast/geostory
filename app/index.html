<!DOCTYPE html>
<html lang="el" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoVisual Stories â€” Editor</title>

<!-- Leaflet (Î­ÎºÎ´Î¿ÏƒÎ· Ï€Î¿Ï… Î¾Î­ÏÎ¿Ï…Î¼Îµ ÏŒÏ„Î¹ Ï€Î±Î¯Î¶ÎµÎ¹ Î¼Îµ leaflet-ui rotate) -->
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<!-- leaflet-ui 0.5.0 (JS Î¼ÏŒÎ½Î¿ â€“ Î±ÏÎºÎµÏ„ÏŒ Î³Î¹Î± rotate/bearing) -->
<script src="https://unpkg.com/leaflet-ui@0.5.0/dist/leaflet-ui.js"></script>

<!-- (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬) GeoPackage reader Î³Î¹Î± browser -->
<script src="https://unpkg.com/@ngageoint/geopackage/dist/geopackage.min.js"></script>

<!-- Turf.js Î³Î¹Î± Î¼ÎµÏ„ÏÎ®ÏƒÎµÎ¹Ï‚ -->
<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Attribute/Share Window styles -->
<link rel="stylesheet" href="/public/css/attrwin.css?v=4" />
<style>
  /* THEME VARIABLES */
  :root{
    --bg:#f7f8fc; --panel:#ffffff; --card:#ffffff; --text:#0b1020;
    --muted:#5a678a; --line:#e6e8f2; --acc:#3b82f6; --acc2:#10b981;
    --chip:#eef2ff; --chip-border:#dbe5ff;
  }
  :root[data-theme="dark"]{
    --bg:#0b1020; --panel:#0f1630; --card:#0d1430; --text:#e8ecff;
    --muted:#9fb0e0; --line:#24324f; --acc:#6aa6ff; --acc2:#00d3a7;
    --chip:#12215c; --chip-border:#2b3c6a;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--acc)}
  .wrap{display:grid;grid-template-columns:380px 1fr;grid-template-rows:auto 1fr;gap:12px;min-height:100vh;padding:12px}
  header{grid-column:1/-1;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 0 0 1px #0002}
  h1{font-size:18px;margin:0}
  .actions{margin-left:auto;display:flex;gap:8px}
  .btn{background:#1a2448;border:1px solid #2b3c6a;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:var(--acc);border-color:#4d88db;color:#081226}
  .btn.btn-sm{padding:6px 10px;font-size:12px}
  .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--text)}
  label{font-size:13px;color:var(--text);display:block;margin:8px 0 6px}
  input[type="text"], textarea, select, input[type="number"], input[type="color"], input[type="search"]{
    width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);font-size:14px
  }
  textarea{min-height:80px;resize:vertical}
  .muted{color:var(--muted);font-size:12px}
  .dropzone{border:2px dashed var(--line);border-radius:12px;padding:14px;text-align:center;color:var(--muted);background:color-mix(in oklab, var(--panel) 90%, transparent)}
  .dropzone.dragover{border-color:var(--acc);color:var(--text);background:color-mix(in oklab, var(--panel) 70%, var(--acc) 10%)}
  .layers{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto}
  .layer{display:flex;justify-content:space-between;align-items:center;gap:8px;background:color-mix(in oklab, var(--panel) 85%, transparent);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
  .layer .meta{display:flex;flex-direction:column}
  .layer .meta small{color:var(--muted)}
  .canvas{border:1px solid var(--line);border-radius:16px;overflow:hidden}
  #map{position:relative;height:100%;min-height:70vh;background:#0a0f1e}

  /* Leaflet controls (generic) */
  .leaflet-control-attribution,
  .leaflet-bar a, .leaflet-bar a:hover{
    background: color-mix(in oklab, var(--panel) 85%, transparent);
    color: var(--muted);
    border-color: var(--line);
  }
  .leaflet-bar a{ color: var(--text); }

  /* Style panel */
  .style-panel{display:none;position:fixed;right:16px;top:16px;width:360px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);z-index:5000}
  .style-panel.active{display:block}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .legend .item{display:flex;align-items:center;gap:6px;background:color-mix(in oklab, var(--panel) 85%, transparent);border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:12px}
  .badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;border:1px solid var(--line)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px;padding:4px 0}
  @media (max-width: 1000px){ .wrap{grid-template-columns:1fr} .style-panel{left:16px;right:16px;width:auto} }

  /* Measure controls (yellow) */
/* Measure controls (yellow) â€” compact 32px ÏÏˆÎ¿Ï‚ */
.measure-tools{
  display:flex; gap:6px; align-items:center;
  padding:4px;
  border-radius:12px;
  backdrop-filter:saturate(1.2) blur(6px);
  background:color-mix(in oklab, var(--panel) 75%, transparent);
  border:1px solid var(--line);
  box-shadow:0 6px 20px rgba(0,0,0,.15);
}

.measure-tools a{
  display:inline-flex !important; align-items:center; justify-content:center;
  width:32px; height:32px;                 /* â† Î¯Î´Î¹Î¿ ÏÏˆÎ¿Ï‚ Î¼Îµ scale input */
  padding:0 !important;
  border-radius:8px;
  border:1px solid var(--measure-border);
  text-decoration:none;
  background:var(--measure-bg); color:var(--measure-fg);
  box-shadow:0 2px 10px rgba(0,0,0,.08);
  transition:transform .08s ease, filter .15s ease, box-shadow .15s ease;
}

.measure-tools a .ico{
  display:flex; align-items:center; justify-content:center;
  width:100%; height:100%;
  font-size:16px;                           /* Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ ÎµÎ¹ÎºÎ¿Î½Î¯Î´Î¹Î¿ */
  line-height:1;
}

.measure-tools a:hover{ filter:brightness(1.05); }
.measure-tools a:active{ transform:translateY(1px) scale(0.98); }
.measure-tools a.active{ outline:2px solid var(--acc); }

:root{ --measure-bg:#f5c518; --measure-border:#d4aa12; --measure-fg:#0b1020; }
:root[data-theme="dark"]{ --measure-bg:#ffd652; --measure-border:#e6bf2a; --measure-fg:#0b1020; }

  /* Default popups (Î¼Î· Identify) */
  :root[data-theme="light"] .leaflet-popup-content-wrapper,
  :root[data-theme="light"] .leaflet-popup-tip { background:#0b1020; color:#ffffff; border-color:#0b1020; }
  :root[data-theme="dark"] .leaflet-popup-content-wrapper,
  :root[data-theme="dark"] .leaflet-popup-tip { background:#ffffff; color:#0b1020; border-color:#ffffff; }
  .leaflet-popup-content { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; }

  /* North Arrow â€” modern glass card */
:root{
  --north-size: 72px;   /* Î¼ÎµÎ¹Ï‰Î¼Î­Î½Î¿ ÎºÎ±Ï„Î¬ ~25% */
  --north-ring: 3px;    /* Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ Î»ÎµÏ€Ï„ÏŒÏ„ÎµÏÎ¿, Î³Î¹Î± Ï€Î¹Î¿ ÏƒÏ‰ÏƒÏ„Î­Ï‚ Î±Î½Î±Î»Î¿Î³Î¯ÎµÏ‚ */
}

.leaflet-control.north-control{
  padding: 8px;
  border-radius: 16px;
  background: color-mix(in oklab, var(--panel) 78%, transparent);
  border: 1px solid var(--line);
  box-shadow: 0 10px 30px rgba(0,0,0,.22);
  backdrop-filter: saturate(1.1) blur(8px);
  user-select: none;
}

.north-card{
  position: relative;
  width: var(--north-size);
  height: var(--north-size);
  display: grid;
  place-items: center;
}
  .north-card::after{
  content:"";
  position:absolute; inset:-6px;
  border-radius:20px;
  pointer-events:none;
  box-shadow:0 0 0 0 rgba(0,0,0,0);
  transition: box-shadow .25s ease;
}
.north-card:hover::after{
  box-shadow:0 10px 28px rgba(0,0,0,.18);
}

.north-N{
  position: absolute;
  top: 2px;
  font-size: 11px;
  font-weight: 800;
  letter-spacing: .14em;
  color: var(--text);
  opacity: .9;
}

.north-svg{ width: 100%; height: 100%; display: block; }

.north-ring{
  fill: none;
  stroke: url(#north-ring-grad);
  stroke-width: var(--north-ring);
}

.north-face{
  fill: color-mix(in oklab, var(--panel) 94%, transparent);
  stroke: color-mix(in oklab, var(--line) 90%, transparent);
  stroke-width: 1;
  filter: drop-shadow(0 2px 8px rgba(0,0,0,.18));
}

.north-needle-body{ fill: var(--acc); }
.north-needle-top{  fill: var(--acc2); }
.north-hub{
  fill: var(--text);
  opacity: .95;
}

.north-needle {
  transform-box: fill-box;
  transform-origin: 50% 50%;
  will-change: transform;
  pointer-events: none;
}

.north-card:hover{
  transform: translateY(-1px);
  transition: transform .15s ease, filter .25s ease;
}

@media (max-width: 600px){
  :root{ --north-size: 64px; }
}

  /* ---------- IDENTIFY POPUP (Excel-like) ---------- */
  :root[data-theme="light"] .identify-popup .leaflet-popup-content-wrapper,
  :root[data-theme="light"] .identify-popup .leaflet-popup-tip{
    background:#ffffff; color:#0b1020; border:1px solid #e6e8f2;
  }
  :root[data-theme="dark"] .identify-popup .leaflet-popup-content-wrapper,
  :root[data-theme="dark"] .identify-popup .leaflet-popup-tip{
    background:#0a0f1e; color:#e8ecff; border:1px solid #24324f;
  }
  .identify-popup .leaflet-popup-content{ margin:10px 12px; }
  .id-title{ font-weight:700; margin:0 0 8px 0; }
  .id-table{ width:100%; border-collapse:collapse; font-size:13px; }
  .id-table th, .id-table td{ padding:6px 8px; border:1px solid var(--line); vertical-align:top; }
  :root[data-theme="light"] .id-table thead th{ background:#f5f7ff; }
  :root[data-theme="dark"]  .id-table thead th{ background:#0b1228; color:#e8ecff; }
  .id-k{ color: var(--muted); width: 40%; }

  /* WINDOWS theme mirrors (attr/share) */
  :root[data-theme="dark"] .win{ background:#0f1630; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .win-header{ background:#0b1228; border-bottom-color:#24324f; }
  :root[data-theme="dark"] .win-toolbar{ background:rgba(255,255,255,0.03); border-bottom-color:#24324f; }
  :root[data-theme="dark"] .win-body{ background:#0a0f1e; }
  :root[data-theme="dark"] .icon-btn{ color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .icon-btn:hover{ border-color:#6aa6ff; }
  :root[data-theme="dark"] .btn{ background:#1a2448; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .btn:hover{ border-color:#6aa6ff; }
  :root[data-theme="dark"] .win-toolbar input[type="search"]{ background:#0a0f1e; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] thead th{ background:#0b1228; border-bottom-color:#24324f; }
  :root[data-theme="dark"] tbody td{ border-bottom-color:#19233d; }
  :root[data-theme="dark"] tbody tr:hover{ background:#0f1630; }

  :root[data-theme="light"] .win{ background:#ffffff; color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] .win-header{ background:#f5f7ff; border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] .win-toolbar{ background:rgba(0,0,0,0.02); border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] .win-body{ background:#ffffff; }
  :root[data-theme="light"] .icon-btn{ color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] .btn{ background:#f2f5ff; color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] thead th{ background:#f5f7ff; border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] tbody td{ border-bottom-color:#eef1f7; }
  :root[data-theme="light"] tbody tr:hover{ background:#f7f9ff; }

  /* ---- Top bar (Scale input + Lock + Measure) ---- */
  .topbar.leaflet-control{
    display:flex; gap:10px; align-items:center; padding:8px;
    border-radius:14px; background: color-mix(in oklab, var(--panel) 75%, transparent);
    border:1px solid var(--line); box-shadow:0 6px 20px rgba(0,0,0,.15);
  }
  .scalebox{
    display:flex; align-items:center; gap:6px; padding:6px 8px;
    border:1px solid var(--line); border-radius:10px; background: color-mix(in oklab, var(--panel) 85%, transparent);
  }
  .scalebox label{ font-size:12px; color:var(--muted); }
  #scaleInput{
    width:110px; padding:6px 8px; border-radius:8px; border:1px solid var(--line);
    background:var(--panel); color:var(--text); font-size:13px;
  }
  #scaleGo{
    padding:6px 10px; border-radius:8px; border:1px solid var(--line); cursor:pointer;
    background:var(--acc); color:#081226; font-weight:700;
  }
  #scaleLock{
    padding:6px 10px; border-radius:8px; border:1px solid var(--line); cursor:pointer;
    background:var(--panel); color:var(--text); font-weight:700;
  }
  #scaleLock.active{ outline:2px solid var(--acc); }

  /* Identify active emphasis */
  .btn.identify-on{
    outline:2px solid var(--acc);
    box-shadow:0 0 0 3px color-mix(in oklab, var(--acc) 30%, transparent);
  }

  /* Custom SCALE control box (graphic only + caption under the bar) */

  .scale-labels {
  display: block;
  position: relative;
  height: 14px;
  margin-bottom: 4px;
  text-align: center;
  font-size: 11px;
  color: #000; /* Ï€Î¬Î½Ï„Î± Î¼Î±ÏÏÎ¿ */
}

  .scale-labels div {
    position: absolute;
    top: 0;
    transform: translateX(-50%);
  }
  .scale-labels div:first-child {
    left: 0%;
    transform: translateX(0%);
    text-align: left;
  }
  .scale-labels div:nth-child(2) {
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  .scale-labels div:last-child {
    left: 100%;
    transform: translateX(-100%);
    text-align: right;
  }

  .scale-bar {
  position: relative;
  height: 10px;
  border: 1px solid #000;
  border-radius: 6px;              /* âœ… Î£Ï„ÏÎ¿Î³Î³Ï…Î»ÎµÎ¼Î­Î½ÎµÏ‚ Î¬ÎºÏÎµÏ‚ */
  overflow: hidden;                /* âœ… Î“Î¹Î± Î½Î± â€œÎºÏŒÎ²ÎµÏ„Î±Î¹â€ ÏƒÏ‰ÏƒÏ„Î¬ Ï„Î¿ gradient */
}

  /* ÎÎ•ÎŸ â€” Ï„Î¿ ÎºÏÎ±Ï„Î¬Ï‚ */
.scale-control {
  background:#fff;
  color:#000;
  border:1px solid #000;
  border-radius:6px;
  padding:6px 8px;
  font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
  box-shadow: 0 4px 14px rgba(0,0,0,.18);
  min-width: 120px;
}

/* scale bar â€“ ÎºÎ¬Ï„Ï‰ Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬, Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ margin */
.leaflet-bottom.leaflet-left {
  margin: 0 0 4px 4px;
}

/* measure+scale toolbar â€“ ÎºÎ¬Ï„Ï‰ Î´ÎµÎ¾Î¹Î¬, ÎµÏ€Î¯ÏƒÎ·Ï‚ Ï€Î¹Î¿ ÎºÎ¿Î½Ï„Î¬ ÏƒÏ„Î± Î¬ÎºÏÎ± */
.leaflet-bottom.leaflet-right {
  margin: 0 4px 4px 0;
}

/* ğŸ‘‰ Î•Î”Î© Î Î¡ÎŸÎ£Î˜Î•Î¤Î•Î™Î£ Î‘Î¥Î¤ÎŸ */
.leaflet-top.leaflet-right {
  margin: 4px 4px 0 0;
}
/* ÎŒÏ„Î±Î½ ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î· Î· ÎºÎ»Î¯Î¼Î±ÎºÎ±, Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î± +/- */
.leaflet-container.zoom-locked .leaflet-control-zoom {
  pointer-events: none;
  opacity: 0.4;   /* Î»Î¯Î³Î¿ â€œÏƒÎ²Î·ÏƒÏ„Î¬â€ Î¿Ï€Ï„Î¹ÎºÎ¬ */
}

  /* HUD (live Î¼Î­Ï„ÏÎ·ÏƒÎ·) Î´Î¯Ï€Î»Î± ÏƒÏ„Î¿Î½ ÎºÎ­ÏÏƒÎ¿ÏÎ± */
  #measureHud{
    position: absolute; pointer-events: none; z-index: 5000;
    transform: translate(12px, 12px);
    font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    padding: 6px 8px; border-radius: 8px; border: 1px solid var(--line);
    box-shadow: 0 6px 20px rgba(0,0,0,.22); display: none;
  }
  :root[data-theme="light"] #measureHud { background:#0b1020; color:#fff; border-color:#0b1020; }
  :root[data-theme="dark"]  #measureHud { background:#fff; color:#0b1020; border-color:#fff; }

  /* Windows should not steal map gestures */
  #attrwin, #sharewin { pointer-events: auto !important; z-index: 99999 !important; }
  #attrwin-header, #sharewin-header { cursor: move !important; pointer-events: auto !important; }
  #attrwin *, #sharewin * { user-select: auto !important; }
/* Zoom controls: Î´Î¹Î±ÎºÏÎ¹Ï„Î¹ÎºÏŒ pulse ÏŒÏ„Î±Î½ Ï€Î±Ï„Î¬Ï‚ */
.leaflet-control-zoom a{
  position: relative;
  transition: transform .12s ease, box-shadow .18s ease, filter .18s ease;
}

.leaflet-control-zoom a.pulse{
  animation: zoomTap .18s ease-out;
}

@keyframes zoomTap{
  0%   { transform: scale(1); }
  50%  { transform: scale(0.94); }
  100% { transform: scale(1); }
}

/* ğŸ‘‰ ÎšÎ¬ÏÏ†Ï‰ÏƒÎµ Ï„Î¿ zoom control ÏƒÏ„Î·Î½ Ï€Î¬Î½Ï‰-Î±ÏÎ¹ÏƒÏ„ÎµÏÎ® Î³Ï‰Î½Î¯Î± */
.leaflet-top.leaflet-left {
  top: 4px;
  left: 4px;
}

.leaflet-top.leaflet-left .leaflet-control-zoom {
  position: absolute;
  top: 0;
  left: 0;
  margin: 4px;   /* ğŸ‘ˆ Î Î¡ÎŸÎ£Î˜Î—ÎšÎ— */
}

/* --- Force-hide default Leaflet/leaflet-ui overlays we don't want --- */
.leaflet-gesture-handling-warning{ display:none !important; } /* Î³ÎºÏÎ¹ Î¼Î®Î½Ï…Î¼Î± */
.leaflet-control-scale,
.leaflet-ui-scale{ display:none !important; }                /* default scale */
.leaflet-control-attribution{ display:none !important; }     /* credits ÎºÎ¬Ï„Ï‰-Î´ÎµÎ¾Î¹Î¬ */

/* Î£Î²Î®ÏƒÎµ Ï„ÎµÎ»ÎµÎ¯Ï‰Ï‚ Ï„Î± overlay loaders Ï„Î¿Ï… leaflet-ui */
.ui-loader,
.leaflet-ui-loader,
.leaflet-ui-loading {
  display: none !important;
  pointer-events: none !important;
}

/* ÎœÎ—Î ÎºÏÏÎ²ÎµÎ¹Ï‚ Î¿Î»ÏŒÎºÎ»Î·ÏÎ¿ Ï„Î¿ zoom button ÏŒÏ„Î±Î½ Î­Ï‡ÎµÎ¹ .leaflet-control-loading */
.leaflet-control-loading {
  pointer-events: auto !important;
}

/* Î£Î²Î®ÏƒÎµ Ï„ÎµÎ»ÎµÎ¯Ï‰Ï‚ Ï„Î¿ Î¼Î¹ÎºÏÏŒ spinner Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ + / - */
.leaflet-control-zoom a.leaflet-control-loading {
  background-image: none !important;
}

.leaflet-control-zoom a.leaflet-control-loading::before,
.leaflet-control-zoom a.leaflet-control-loading::after {
  content: none !important;
  display: none !important;
}

/* leaflet-ui toolbars & buttons (Ï„Î± ÎºÎ¯Ï„ÏÎ¹Î½Î±) */
.leaflet-ui-control,
.leaflet-control-toolbar,
.leaflet-control-measure,
.leaflet-control-zoomslider,
.leaflet-control-basemaps,
.leaflet-control-minimap,
.leaflet-control-geocoder,
.leaflet-control-locate,
.leaflet-control-fullscreen,
.leaflet-control-credits,
.ui-control,
.ui-buttons,
.ui-btn {
  display: none !important;
}

/* Î¼Î·Î½ ÎµÎ¼Ï†Î±Î½Î¯ÏƒÎµÎ¹ Ï„Î¯Ï€Î¿Ï„Î± ÎºÎ±Î¹ ÎºÎ¬Ï„Ï‰ Î´ÎµÎ¾Î¹Î¬ */
.leaflet-bottom.leaflet-right .leaflet-ui-control,
.leaflet-bottom.leaflet-right .leaflet-control-toolbar { 
  display:none !important;
}


</style>
<style>
/* Fallback: ÎµÏ€Î¹Î²Î¬Î»Î»ÎµÎ¹ Ï€Î»Ï‰Ï„Î¬ Ï€Î±ÏÎ¬Î¸Ï…ÏÎ± Î±ÎºÏŒÎ¼Î± ÎºÎ¹ Î±Î½ Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÏƒÎµÎ¹ Ï„Î¿ attrwin.css */
.win{
  position: fixed;
  bottom: 16px; left: 16px;
  max-width: 70vw; max-height: 60vh;
  border: 1px solid var(--line);
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 12px 40px rgba(0,0,0,.35);
  z-index: 100000;
}
#sharewin{ left: auto; right: 16px; }
.win.hidden{ display: none !important; }
.win-header{ display:flex; align-items:center; justify-content:space-between; }
.win-body{ overflow:auto; }
.win-resize-handle{
  position:absolute; right:0; bottom:0; width:14px; height:14px; cursor:nwse-resize;
}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><h1>GeoVisual Stories â€” Editor</h1></div>
      <div class="actions">
        <button id="themeToggle" class="btn" title="Theme: toggle light/dark">ğŸŒ— Theme</button>
        <button id="btnGenerate" class="btn primary" title="Î”Î·Î¼Î¹Î¿ÏÏÎ³Î·ÏƒÎµ Î´Î·Î¼ÏŒÏƒÎ¹Î¿ link Î³Î¹Î± Ï€ÏÎ¿Î²Î¿Î»Î®">Generate Link</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="card">
        <h3>Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Project</h3>
        <label>Î¤Î¯Ï„Î»Î¿Ï‚</label>
        <input id="title" type="text" placeholder="Ï€.Ï‡. Flood Risk â€” Thessaly 2025">
        <label>Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®</label>
        <textarea id="desc" placeholder="Î£ÏÎ½Ï„Î¿Î¼Î· Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®/Î¼ÎµÎ¸Î¿Î´Î¿Î»Î¿Î³Î¯Î±..."></textarea>
      </div>

      <div class="card">
        <h3>Basemap</h3>
        <select id="basemap" title="Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï…Ï€ÏŒÎ²Î±Î¸ÏÎ¿">
          <option value="osm">OpenStreetMap</option>
          <option value="sat">Satellite (Esri)</option>
          <option value="topo">Topographic (OpenTopoMap)</option>
        </select>
        <div class="muted" style="margin-top:6px">Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï…Ï€ÏŒÎ²Î±Î¸ÏÎ¿</div>
      </div>

      <div class="card">
        <h3>Î‘ÏÏ‡ÎµÎ¯Î±</h3>
        <div id="drop" class="dropzone">
          Î£ÏÏÎµ ÎµÎ´Ï Î±ÏÏ‡ÎµÎ¯Î± Î® <label style="text-decoration:underline;cursor:pointer">
            ÎµÏ€Î¯Î»ÎµÎ¾Îµ<input id="file" type="file" accept=".geojson,.json,.gpkg" multiple style="display:none">
          </label>
          <div class="muted" style="margin-top:6px">Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·: <b>GeoJSON</b> & <b>GeoPackage</b>*. Î“Î¹Î± Shapefile âœ export ÏƒÎµ GeoJSON.</div>
          <div class="muted">* Î‘Î½ Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏƒÎ±Î¹ GeoPackage, Î±Ï†Î±Î¯ÏÎµÏƒÎµ Ï„Î¿ ÏƒÏ‡ÎµÏ„Î¹ÎºÏŒ &lt;script&gt; Î³Î¹Î± Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ Î¼Î­Î³ÎµÎ¸Î¿Ï‚.</div>
        </div>
      </div>

      <div class="card">
        <h3>Î£Ï„ÏÏÏƒÎµÎ¹Ï‚</h3>
        <div id="layerList" class="layers"></div>
        <div class="muted">ğŸ‘ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·/Î±Ï€ÏŒÎºÏÏ…ÏˆÎ· â€” ğŸ§¾ attributes â€” ğŸ¨ style â€” ğŸ›ˆ identify â€” ğŸ—‘ Î´Î¹Î±Î³ÏÎ±Ï†Î® â€” auto fit</div>
      </div>

      <div class="card">
        <h3>Î ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼Î¿Î¯ Free</h3>
        <div class="muted">ÎˆÏ‰Ï‚ <strong>3 layers</strong> â€” link Î´Î¹Î±ÏÎºÎµÎ¯ <strong>7 Î·Î¼Î­ÏÎµÏ‚</strong>.</div>
      </div>
    </aside>

    <section class="canvas"><div id="map"></div></section>

 <footer>v0.3 â€” Per-Layer Styling â€¢ Unique/Graduated â€¢ Attributes â€¢ Identify â€¢ Basemaps â€¢ (Opt) GeoPackage â€¢ Dark/Light â€¢ Data Â© OpenStreetMap contributors, Esri, OpenTopoMap</footer>
  </div>

  <!-- STYLE PANEL (per layer) -->
  <div id="stylePanel" class="style-panel">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <h3 id="spTitle" style="margin:0;font-size:15px">Layer style</h3>
      <button id="spClose" class="btn" title="ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿">âœ•</button>
    </div>
    <div class="muted" id="spGeom" style="margin-top:4px"></div>

    <div class="card" style="margin-top:8px">
      <h3>Renderer</h3>
      <select id="renderer" title="Î¤ÏÏ€Î¿Ï‚ ÏƒÏ…Î¼Î²Î¿Î»Î¿Î³Î¯Î±Ï‚">
        <option value="single">Single symbol</option>
        <option value="unique">Unique values (categorical)</option>
        <option value="graduated">Graduated (quantiles)</option>
      </select>
    </div>

    <div class="card" id="singleBlock">
      <h3>Single symbol</h3>
      <div class="row">
        <div>
          <label>Fill color</label>
          <input type="color" id="fillColor" value="#4361ee">
        </div>
        <div>
          <label>Stroke color</label>
          <input type="color" id="strokeColor" value="#4cc9f0">
        </div>
      </div>
      <div class="row">
        <div>
          <label>Stroke width (px)</label>
          <input type="number" id="strokeWidth" min="0" max="12" value="2">
        </div>
        <div>
          <label>Opacity</label>
          <input type="number" id="opacity" min="0" max="1" step="0.05" value="0.75">
        </div>
      </div>
      <div id="pointOpts" class="row" style="margin-top:8px">
        <div>
          <label>Point size (px)</label>
          <input type="number" id="pointSize" min="4" max="32" value="10">
        </div>
        <div>
          <label>Point shape</label>
          <select id="pointShape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card" id="fieldBlock">
      <h3>Field / Palette</h3>
      <label>Attribute field</label>
      <select id="fieldSelect"></select>

      <div id="paletteBlock" style="margin-top:8px">
        <label>Color palette</label>
        <select id="paletteSelect">
          <option value="category10">Category10</option>
          <option value="set3">Set3</option>
          <option value="pastel">Pastel</option>
          <option value="viridis">Viridis</option>
          <option value="magma">Magma</option>
          <option value="plasma">Plasma</option>
          <option value="blues">Blues</option>
          <option value="reds">Reds</option>
          <option value="greens">Greens</option>
        </select>
      </div>

      <div id="classesBlock" style="margin-top:8px">
        <label>Classes (graduated)</label>
        <input type="number" id="classCount" min="3" max="9" value="5">
      </div>

      <div class="legend" id="legendPreview"></div>
    </div>

    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="applyStyle" class="btn primary" title="Î•Ï†Î±ÏÎ¼Î¿Î³Î® ÏƒÏ…Î¼Î²Î¿Î»Î¿Î³Î¯Î±Ï‚">Apply</button>
      <button id="resetStyle" class="btn" title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬">Reset</button>
    </div>
  </div>

  <!-- Attribute Table Window -->
  <div id="attrwin" class="win hidden" role="dialog" aria-label="Attribute table" aria-modal="false">
    <div class="win-header" id="attrwin-header">
      <div class="win-title"><span id="attrwin-title">Attribute Table</span></div>
      <div class="win-actions">
        <button class="icon-btn" id="attrwin-max" title="Maximize/Restore" aria-label="Maximize">â¬œ</button>
        <button class="icon-btn danger" id="attrwin-close" title="Close" aria-label="Close">âœ•</button>
      </div>
    </div>
    <div class="win-toolbar">
      <input id="attrwin-search" type="search" placeholder="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·â€¦" />
      <button id="attrwin-csv" class="btn btn-sm" title="Export CSV">Export CSV</button>
      <span id="attrwin-count" class="muted"></span>
    </div>
    <div class="win-body">
      <table id="attrwin-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="win-resize-handle" id="attrwin-resize" aria-hidden="true"></div>
  </div>

  <!-- Share Link Window -->
  <div id="sharewin" class="win hidden" role="dialog" aria-label="Share link" aria-modal="false">
    <div class="win-header" id="sharewin-header">
      <div class="win-title"><span id="sharewin-title">Share Link</span></div>
      <div class="win-actions">
        <button class="icon-btn danger" id="sharewin-close" title="Close" aria-label="Close">âœ•</button>
      </div>
    </div>
    <div class="win-toolbar">
      <input id="sharewin-url" type="search" placeholder="Linkâ€¦" readonly />
      <button id="sharewin-copy" class="btn btn-sm" title="Copy link">Copy</button>
      <span id="sharewin-status" class="muted"></span>
    </div>
    <div class="win-body" style="display:flex;align-items:center;justify-content:center;">
      <div class="muted">Î¤Î¿ link Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ. Î Î¬Ï„Î·ÏƒÎµ <b>Copy</b> Î³Î¹Î± Î±Î½Ï„Î¹Î³ÏÎ±Ï†Î®.</div>
    </div>
    <div class="win-resize-handle" id="sharewin-resize" aria-hidden="true"></div>
  </div>

  <!-- Import shared attr window -->
  <script type="module">
    import { openAttrWindow, setAttrData } from '/public/js/attrwin.js?v=4';
    const winEl = document.getElementById('attrwin');
    ['wheel','mousedown','dblclick','touchstart','pointerdown','contextmenu']
      .forEach(ev => winEl.addEventListener(ev, e => e.stopPropagation(), { passive:true }));
    window.openAttrWindow = openAttrWindow;
    window.setAttrData = setAttrData;
  </script>

<script>
  // ---------- THEME ----------
  (function(){
    const root = document.documentElement;
    const KEY  = 'geostory-theme';
    const btn  = document.getElementById('themeToggle');
    function setTheme(t){
      const theme = (t === 'light') ? 'light' : 'dark';
      root.setAttribute('data-theme', theme);
      localStorage.setItem(KEY, theme);
      btn.title = `Theme: ${theme}`;
    }
    const saved = localStorage.getItem(KEY);
    setTheme(saved || 'dark');
    btn.addEventListener('click', ()=>{
      const cur = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
      setTheme(cur === 'dark' ? 'light' : 'dark');
    });
  })();

  function escapeHtml(s){
    return String(s ?? '').replace(/[&<>\"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ---------- Share Link Window ----------
  (function(){
    const win = document.getElementById('sharewin');
    const header = document.getElementById('sharewin-header');
    const closeBtn = document.getElementById('sharewin-close');
    const input = document.getElementById('sharewin-url');
    const copyBtn = document.getElementById('sharewin-copy');
    const statusEl = document.getElementById('sharewin-status');
    const resizeHandle = document.getElementById('sharewin-resize');

    ['wheel','mousedown','dblclick','touchstart','pointerdown','contextmenu']
      .forEach(ev => win.addEventListener(ev, e => e.stopPropagation(), { passive:true }));

    function openShareWindow(url){
      input.value = url || '';
      statusEl.textContent = '';
      win.classList.remove('hidden');
      bringToFront();
      setTimeout(()=>{ input.focus(); input.select(); }, 0);
    }
    function closeShareWindow(){ win.classList.add('hidden'); }
    async function doCopy(){
      try{
        await navigator.clipboard.writeText(input.value);
        statusEl.textContent = 'Copied!';
        setTimeout(()=> statusEl.textContent = '', 1500);
      }catch(e){
        input.select();
        statusEl.textContent = 'Select + Ctrl/Cmd+C';
        setTimeout(()=> statusEl.textContent = '', 2000);
      }
    }

    // Drag
    let drag = null;
    header.addEventListener('mousedown', (e)=>{
      if(e.button!==0) return;
      e.preventDefault();
      const rect = win.getBoundingClientRect();
      drag = { ox: e.clientX - rect.left, oy: e.clientY - rect.top };
      bringToFront();
      window.addEventListener('mousemove', onDrag);
      window.addEventListener('mouseup', stopDrag);
    });
    function onDrag(e){
      if(!drag) return;
      const x = Math.max(0, e.clientX - drag.ox);
      const y = Math.max(0, e.clientY - drag.oy);
      win.style.left = x + 'px';
      win.style.top = y + 'px';
    }
    function stopDrag(){
      window.removeEventListener('mousemove', onDrag);
      window.removeEventListener('mouseup', stopDrag);
      drag = null;
    }

    // Resize
    let rz = null;
    resizeHandle.addEventListener('mousedown', (e)=>{
      if(e.button!==0) return;
      e.preventDefault();
      const rect = win.getBoundingClientRect();
      rz = { sx: e.clientX, sy: e.clientY, w: rect.width, h: rect.height };
      bringToFront();
      window.addEventListener('mousemove', onResize);
      window.addEventListener('mouseup', stopResize);
    });
    function onResize(e){
      if(!rz) return;
      const w = Math.max(420, rz.w + (e.clientX - rz.sx));
      const h = Math.max(220, rz.h + (e.clientY - rz.sy));
      win.style.width = w + 'px';
      win.style.height = h + 'px';
    }
    function stopResize(){
      window.removeEventListener('mousemove', onResize);
      window.removeEventListener('mouseup', stopResize);
      rz = null;
    }

    function bringToFront(){
      const z = 100000 + (Date.now() % 10000);
      win.style.zIndex = z;
    }
    win.addEventListener('mousedown', bringToFront);

    closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); closeShareWindow(); });
    copyBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); doCopy(); });

    document.addEventListener('keydown', (e)=>{
      if(e.key==='Escape' && !win.classList.contains('hidden')) closeShareWindow();
    });

    window.__openShareWindow = openShareWindow;
  })();

  // ---------- MAP ----------
  const basemaps = {
    osm: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}),
    sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Esri'}),
    topo:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'OpenTopoMap'})
  };
const map = L.map('map', {
  zoomControl: false,
  attributionControl: false,
  rotate: true,
  bearing: 0,
  touchRotate: true,
  shiftKeyRotate: true,
  gestureHandling: false
});

// ğŸ”’ Global Î¼ÎµÏ„Î±Î²Î»Î·Ï„Î® Î³Î¹Î± Ï„Î¿ Lock
const mapContainer = map.getContainer();
let zoomLocked = false;

// custom zoom control, Î Î‘ÎÎ© Î‘Î¡Î™Î£Î¤Î•Î¡Î‘
L.control.zoom({ position: 'topleft' }).addTo(map);


// Zoom pulse animation on click
const zoomCtrlEl = document.querySelector('.leaflet-control-zoom');
if (zoomCtrlEl){
  zoomCtrlEl.addEventListener('click', (e)=>{
    const btn = e.target.closest('a');
    if (!btn) return;
    btn.classList.remove('pulse');
    // force reflow
    void btn.offsetWidth;
    btn.classList.add('pulse');
  });
}

// ÎµÎ¾Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎµ ÏŒÏ„Î¹ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î· ÏÎ¿Î´Î­Î»Î±/zoom Ï‡Ï‰ÏÎ¯Ï‚ overlay
// ÎµÎ¾Î±ÏƒÏ†Î¬Î»Î¹ÏƒÎµ ÏŒÏ„Î¹ Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ Î· ÏÎ¿Î´Î­Î»Î±/zoom Ï‡Ï‰ÏÎ¯Ï‚ overlay
map.scrollWheelZoom.enable();
map.touchZoom.enable();
if (map.gestureHandling?.disable) map.gestureHandling.disable();

// ğŸ”’ Î‘Î½ ÎµÎ¯Î½Î±Î¹ ÎµÎ½ÎµÏÎ³ÏŒ Ï„Î¿ Lock, ÎºÏŒÎ²Î¿Ï…Î¼Îµ wheel / touch zoom ÏƒÎµ ÎµÏ€Î¯Ï€ÎµÎ´Î¿ DOM
['wheel', 'touchstart', 'gesturestart'].forEach(ev => {
  mapContainer.addEventListener(ev, (e) => {
    if (zoomLocked) {
      e.preventDefault();
      e.stopPropagation();
    }
  }, { passive: false, capture: true });
});

// Î‘Î½ Ï€ÏÎ¿ÏƒÏ€Î±Î¸Î®ÏƒÎµÎ¹ Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎµÎ¹ zoom ÎµÎ½Ï ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿, ÏƒÏ„Î±Î¼Î¬Ï„Î± Ï„Î¿
map.on('zoomstart', () => {
  if (zoomLocked) {
    map.stop();
  }
});

let currentBase='osm'; 
basemaps.osm.addTo(map); 
map.setView([38,23.7],6);

  
// ÎšÎ±Î¸Î¬ÏÎ¹ÏƒÎµ ÎŸÎ›Î‘ Ï„Î± leaflet-ui toolbars & ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ (ÎºÏÎ±Ï„Î¬Î¼Îµ Î¼ÏŒÎ½Î¿ Ï„Î¿ rotate API)
map.whenReady(() => {
  function cleanup() {
    // 1) ÎºÎ»Î±ÏƒÎ¹ÎºÏŒ ÎºÎ±Î¸Î¬ÏÎ¹ÏƒÎ¼Î± ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ leaflet-ui controls
    const selector = `
      .leaflet-control-basemaps,
      .leaflet-control-minimap,
      .leaflet-control-geocoder,
      .leaflet-control-locate,
      .leaflet-control-fullscreen,
      .leaflet-control-measure,
      .leaflet-control-zoomslider,
      .leaflet-control-credits,
      .leaflet-ui-control,
      .leaflet-control-toolbar,
      .leaflet-control-layers,
      .ui-control,
      .ui-buttons,
      .ui-btn
    `;
    document.querySelectorAll(selector).forEach(el => el.remove());

    const container = map.getContainer();

    // 2) Î Î‘ÎÎ©-Î”Î•ÎÎ™Î‘: Î¬Î´ÎµÎ¹Î±ÏƒÎµ Ï„Î± Ï€Î¬Î½Ï„Î±
const topRight = container.querySelector('.leaflet-top.leaflet-right');
if (topRight) {
  Array.from(topRight.children).forEach(c => {
    // Î±Î½ Î”Î•Î ÎµÎ¯Î½Î±Î¹ Î· Î´Î¹ÎºÎ¹Î¬ Î¼Î±Ï‚ north-control, ÏƒÎ²Î®Ïƒâ€™ Ï„Î¿
    if (!c.classList.contains('north-control')) {
      topRight.removeChild(c);
    }
  });
}

    // 3) ÎšÎ‘Î¤Î©-Î”Î•ÎÎ™Î‘: ÎšÎ¡Î‘Î¤Î‘ ÎœÎŸÎÎŸ Ï„Î¿ Î´Î¹ÎºÏŒ Î¼Î±Ï‚ topbar control
    const bottomRight = container.querySelector('.leaflet-bottom.leaflet-right');
    if (bottomRight) {
      Array.from(bottomRight.children).forEach(c => {
        // ÎµÎ´Ï ÎºÎ¿Î¹Ï„Î¬Î¼Îµ Î¤ÎŸ Î™Î”Î™ÎŸ Ï„Î¿ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î¿
        if (!c.classList.contains('topbar')) {
          bottomRight.removeChild(c);
        }
      });
    }

    // 4) Extra: Ï€ÎµÏ„Î¬ Î¼ÎµÎ¼Î¿Î½Ï‰Î¼Î­Î½Î± ÎºÎ¿Ï…Î¼Ï€Î¹Î¬ fullscreen / search / rotate
    document.querySelectorAll(
      'a[title="Enter fullscreen"],' +
      'a[title="Exit fullscreen"],'  +
      'a[title="Search"],'           +
      'a[title="Rotate map"]'
    ).forEach(btn => {
      const ctl = btn.closest('.leaflet-control') ||
                  btn.closest('.leaflet-right')   ||
                  btn;
      if (ctl && ctl.parentNode) ctl.parentNode.removeChild(ctl);
    });
  }

  cleanup();
  setTimeout(cleanup, 100);
  setTimeout(cleanup, 500);
});

// --- North Arrow Control (modern + rotatable) ---
const NorthControl = L.Control.extend({
  options: { position: 'topright' },
  onAdd() {
    const div = L.DomUtil.create('div', 'leaflet-control north-control');
    const card = L.DomUtil.create('div', 'north-card', div);
    const nLab = L.DomUtil.create('div', 'north-N', card);
    nLab.textContent = 'N';

    card.innerHTML += `
      <svg viewBox="0 0 100 100" class="north-svg" aria-hidden="true">
        <defs>
          <linearGradient id="north-ring-grad" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%"   stop-color="var(--acc)"/>
            <stop offset="100%" stop-color="var(--acc2)"/>
          </linearGradient>
          <radialGradient id="north-gloss-grad" cx="50%" cy="30%" r="60%">
            <stop offset="0%"  stop-color="#fff" stop-opacity="0.45"/>
            <stop offset="60%" stop-color="#fff" stop-opacity="0.05"/>
            <stop offset="100%" stop-color="#fff" stop-opacity="0"/>
          </radialGradient>
          <filter id="north-soft" x="-20%" y="-20%" width="140%" height="140%">
            <feDropShadow dx="0" dy="0" stdDeviation="0.6" flood-color="rgba(0,0,0,.35)"/>
          </filter>
        </defs>

        <circle class="north-ring" cx="50" cy="50" r="46"/>
        <circle class="north-face" cx="50" cy="50" r="38"/>

        <g stroke="currentColor" stroke-width="1.6" opacity=".6" filter="url(#north-soft)">
          <line x1="50" y1="12" x2="50" y2="20"/>
          <line x1="50" y1="80" x2="50" y2="88"/>
          <line x1="80" y1="50" x2="88" y2="50"/>
          <line x1="12" y1="50" x2="20" y2="50"/>
        </g>

        <g stroke="currentColor" stroke-width="1" opacity=".35">
          ${[45,135,225,315].map(a=>{
            const rad=a*Math.PI/180, r1=35, r2=38;
            const x1=50+Math.cos(rad)*r1, y1=50+Math.sin(rad)*r1;
            const x2=50+Math.cos(rad)*r2, y2=50+Math.sin(rad)*r2;
            return `<line x1="${x1.toFixed(2)}" y1="${y1.toFixed(2)}" x2="${x2.toFixed(2)}" y2="${y2.toFixed(2)}"/>`;
          }).join('')}
        </g>

        <g class="north-needle">
          <path class="north-needle-body" d="M50 12 L59 50 L50 88 L41 50 Z"/>
          <path class="north-needle-top"  d="M50 12 L59 50 L50 50 L41 50 Z"/>
          <circle class="north-hub" cx="50" cy="50" r="3.4"/>
        </g>

        <circle cx="50" cy="50" r="38" fill="url(#north-gloss-grad)"/>
      </svg>
    `;

    const needle = card.querySelector('.north-needle');
    needle.style.transformOrigin = '50% 50%';
    function syncNeedle(){
      const deg = -(map.getBearing?.() || 0);
      needle.style.transform = `rotate(${deg}deg)`;
    }
    ['move','zoom'].forEach(ev => map.on(ev, syncNeedle));
    syncNeedle();

    let dragging=false, startAngle=0, startBearing=0;
    function angleFromCenter(e){
      const r = card.getBoundingClientRect();
      const cx = r.left + r.width/2, cy = r.top + r.height/2;
      const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
      const x = pt.clientX - cx, y = pt.clientY - cy;
      return Math.atan2(y, x) * 180/Math.PI;
    }
    function onMove(e){
      if(!dragging) return;
      e.preventDefault();
      const delta = angleFromCenter(e) - startAngle;
      map.setBearing?.(startBearing + delta);
      syncNeedle();
    }
    function onUp(){
      dragging=false; card.style.cursor='';
      window.removeEventListener('mousemove', onMove);
      window.removeEventListener('mouseup', onUp);
      window.removeEventListener('touchmove', onMove);
      window.removeEventListener('touchend', onUp);
    }
    card.addEventListener('mousedown', (e)=>{
      e.preventDefault(); e.stopPropagation();
      dragging=true; card.style.cursor='grabbing';
      startAngle = angleFromCenter(e);
      startBearing = map.getBearing?.() || 0;
      window.addEventListener('mousemove', onMove);
      window.addEventListener('mouseup', onUp);
    });
    card.addEventListener('touchstart', (e)=>{
      e.preventDefault(); e.stopPropagation();
      dragging=true; card.style.cursor='grabbing';
      startAngle = angleFromCenter(e);
      startBearing = map.getBearing?.() || 0;
      window.addEventListener('touchmove', onMove, {passive:false});
      window.addEventListener('touchend', onUp);
    });

    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);
    return div;
  }
});

  document.getElementById('basemap').value = currentBase;

  // ---------- STATE ----------
  let layers = []; // { id, name, gj, leaflet, visible, kind, style, fields }
  const elBasemap = document.getElementById('basemap');
  const elDrop = document.getElementById('drop');
  const elList = document.getElementById('layerList');

  // ---------- UTILS ----------
  function detectKind(gj){
    let p=false,l=false,a=false;
    (gj.features||[]).forEach(f=>{
      const t=f.geometry?.type||'';
      if(/Point$/.test(t)) p=true; else if(/LineString$/.test(t)) l=true; else if(/Polygon$/.test(t)) a=true;
    });
    const c=[p,l,a].filter(Boolean).length;
    if(c>1) return 'mixed'; if(p) return 'point'; if(l) return 'line'; if(a) return 'poly'; return 'mixed';
  }
  function fieldsFrom(gj){
    const f = (gj.features||[]).find(x=>x.properties && Object.keys(x.properties).length);
    return f ? Object.keys(f.properties) : [];
  }
  function quantiles(values, k){
    const v = values.filter(x=>typeof x==='number' && isFinite(x)).sort((a,b)=>a-b);
    if(!v.length) return [];
    const qs=[], step=1/k;
    for(let i=1;i<k;i++){
      const pos = (v.length-1)*step*i; const lo=Math.floor(pos), hi=Math.ceil(pos);
      const q=lo===hi? v[lo] : v[lo]*(hi-pos)+v[hi]*(pos-lo);
      qs.push(q);
    }
    return qs;
  }

  const PALETTES = {
    category10: ["#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b","#e377c2","#7f7f7f","#bcbd22","#17becf"],
    set3: ["#8dd3c7","#ffffb3","#bebada","#fb8072","#80b1d3","#fdb462","#b3de69","#fccde5","#d9d9d9","#bc80bd","#ccebc5"],
    pastel: ["#aec7e8","#ffbb78","#98df8a","#ff9896","#c5b0d5","#c49c94","#f7b6d2","#c7c7c7","#dbdb8d","#9edae5"],
    viridis: ["#440154","#46327e","#365c8d","#277f8e","#1fa187","#4ac16d","#9fd744","#fde725"],
    magma: ["#000004","#1b0c41","#4f0a6d","#88226a","#b63679","#e65164","#fb8761","#fec287","#fbfdbf"],
    plasma:["#0d0887","#6a00a8","#b12a90","#e16462","#fca636","#f0f921"],
    blues: ["#eff3ff","#c6dbef","#9ecae1","#6baed6","#3182bd","#08519c"],
    reds:  ["#fee5d9","#fcbba1","#fc9272","#fb6a4a","#de2d26","#a50f15"],
    greens:["#edf8e9","#c7e9c0","#74c476","#41ab5d","#238b45","#005a32"]
  };

  // ---------- IDENTIFY ----------
  const identify = { active:false, layerId:null, btnEl:null };
  function setIdentify(layerId, btnEl){
    if(identify.active && identify.layerId === layerId){
      identify.active = false; identify.layerId = null;
      btnEl?.classList.remove('primary','identify-on');
      document.getElementById('map').style.cursor = '';
      return;
    }
    if(identify.btnEl) identify.btnEl.classList.remove('primary','identify-on');
    identify.active = true;
    identify.layerId = layerId;
    identify.btnEl = btnEl || null;
    btnEl?.classList.add('primary','identify-on');
    document.getElementById('map').style.cursor = 'help';
  }
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && identify.active){
      identify.active = false; identify.layerId = null;
      identify.btnEl?.classList.remove('primary','identify-on');
      document.getElementById('map').style.cursor = '';
    }
  });

  function identifyPopupHtml(layerName, props){
    const rows = Object.entries(props||{}).map(([k,v])=>
      `<tr><td class="id-k">${escapeHtml(k)}</td><td>${escapeHtml(v)}</td></tr>`
    ).join('');
    return `
      <div class="id-wrap">
        <div class="id-title">${escapeHtml(layerName)}</div>
        <table class="id-table">
          <thead><tr><th>Field</th><th>Value</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }

  // ---------- RENDERING ----------
  function defaultStyle(kind){
    return {
      renderer: 'single',
      single: { fill:"#4361ee", stroke:"#4cc9f0", width:2, opacity:0.75, pointSize:10, pointShape:'circle' },
      unique: { field:null, palette:"category10", legend:[] },
      graduated: { field:null, classes:5, palette:"viridis", breaks:[], legend:[] },
      kind
    };
  }
  function buildLeaflet(layer){
    const st = layer.style;
    const symb = (feature)=>{
      if(st.renderer==='single'){
        const s = st.single;
        return { color: s.stroke, weight: s.width, fillColor: s.fill, fillOpacity: layer.kind==='line'?0 : s.opacity };
      }
      if(st.renderer==='unique' && st.unique.field){
        const v = feature.properties?.[st.unique.field];
        const item = st.unique.legend.find(x=> String(x.value)===String(v));
        const color = item ? item.color : '#999';
        return { color, weight: 2, fillColor: color, fillOpacity: layer.kind==='line'?0 : 0.6 };
      }
      if(st.renderer==='graduated' && st.graduated.field){
        const val = Number(feature.properties?.[st.graduated.field]);
        const br = st.graduated.breaks, cols = st.graduated.legend;
        let idx = br.findIndex(b => val <= b); if(idx<0) idx = cols.length-1;
        const color = cols[idx]?.color || '#999';
        return { color, weight: 2, fillColor: color, fillOpacity: layer.kind==='line'?0 : 0.6 };
      }
      return { color:'#4cc9f0', weight:2, fillColor:'#4361ee', fillOpacity:0.6 };
    };

    const pointToLayer = (feature, latlng)=>{
      if(!/Point$/.test(feature.geometry?.type||'')) return null;
      const s = st.single;
      const style = symb(feature);
      const size = st.renderer==='single' ? s.pointSize : 10;
      const fill = style.fillColor || s.fill;
      const stroke = style.color || s.stroke;
      if(s.pointShape==='square'){
        const html = `<div style="
          width:${size*2}px;height:${size*2}px;
          transform:translate(-50%,-50%);
          background:${fill};
          border:1px solid ${stroke};
          opacity:${layer.kind==='line'?0:0.8};
          border-radius:4px;"></div>`;
        const icon = L.divIcon({ html, className:'', iconSize:[0,0] });
        return L.marker(latlng, { icon, interactive:true });
      }
      return L.circleMarker(latlng,{ radius:size, color: stroke, weight:1, fillColor: fill, fillOpacity:0.8 });
    };

    return L.geoJSON(layer.gj, {
      pointToLayer: (f,latlng)=> pointToLayer(f,latlng) || L.circleMarker(latlng,{radius:8,color:'#999',fillColor:'#999',fillOpacity:.7}),
      style: (f)=> symb(f),
      onEachFeature:(f,l)=>{
        l.on('click', (ev)=>{
          if(!(identify.active && identify.layerId === layer.id)) return;
          L.DomEvent.stop(ev);
          const html = identifyPopupHtml(layer.name, f.properties||{});
          L.popup({ closeButton:true, className:'identify-popup' })
            .setLatLng(ev.latlng)
            .setContent(html)
            .openOn(map);
        });
      }
    });
  }

  function renderList(){
    const elList = document.getElementById('layerList');
    elList.innerHTML='';
    if(!layers.length){ elList.innerHTML='<div class="muted">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ layers Î±ÎºÏŒÎ¼Î·.</div>'; return; }
    layers.forEach(L=>{
      const row=document.createElement('div'); row.className='layer';
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML = `<div>${escapeHtml(L.name)}</div><small>${L.kind}</small>`;
      const controls=document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px';

      const eye=document.createElement('button'); eye.className='btn'; eye.textContent=L.visible?'ğŸ‘':'ğŸš«';
      eye.onclick=()=>{ L.visible=!L.visible; if(L.visible) L.leaflet.addTo(map); else map.removeLayer(L.leaflet); eye.textContent=L.visible?'ğŸ‘':'ğŸš«'; };

      const tbl=document.createElement('button'); tbl.className='btn'; tbl.textContent='ğŸ§¾'; tbl.title='Attribute table';
      tbl.onclick=()=> openAttrTable(L.id);

      const sty=document.createElement('button'); sty.className='btn'; sty.textContent='ğŸ¨'; sty.title='Style'; sty.onclick=()=> openStylePanel(L.id);

      const idBtn=document.createElement('button'); idBtn.className='btn'; idBtn.textContent='ğŸ›ˆ'; idBtn.title='Identify (click features)';
      idBtn.onclick=()=> setIdentify(L.id, idBtn);

      const del=document.createElement('button'); del.className='btn'; del.textContent='ğŸ—‘'; del.title='Delete';
      del.onclick=()=>{
        if(identify.active && identify.layerId === L.id){
          identify.active = false; identify.layerId = null;
          identify.btnEl?.classList.remove('primary','identify-on');
          document.getElementById('map').style.cursor = '';
        }
        map.removeLayer(L.leaflet); layers = layers.filter(x=>x.id!==L.id); renderList();
      };

      controls.appendChild(eye);
      controls.appendChild(tbl);
      controls.appendChild(sty);
      controls.appendChild(idBtn);
      controls.appendChild(del);
      row.appendChild(meta); row.appendChild(controls);
      elList.appendChild(row);
    });
  }

  function addGeoJSON(name, gj){
    const id='lyr_'+Math.random().toString(36).slice(2,9);
    const kind=detectKind(gj);
    const style = defaultStyle(kind);
    const leaflet = buildLeaflet({ id, gj, name, style, kind });
    leaflet.addTo(map);
    try{ map.fitBounds(leaflet.getBounds(),{padding:[20,20]}); }catch(_){}
    layers.push({ id,name,gj,leaflet,visible:true,kind,style,fields:fieldsFrom(gj) });
    renderList();
  }

  // ---------- FILE HANDLING ----------
  document.getElementById('file').addEventListener('change', async e=>{ await handleFiles(e.target.files); e.target.value=''; });
  ['dragenter','dragover'].forEach(evt=> elDrop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); elDrop.classList.add('dragover'); }));
  ['dragleave','drop'].forEach(evt=> elDrop.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); elDrop.classList.remove('dragover'); }));
  elDrop.addEventListener('drop', async e=>{ await handleFiles(e.dataTransfer.files); });

  async function handleFiles(list){
    const files=[...list];
    for(const f of files){
      const fn=f.name.toLowerCase();
      if(fn.endsWith('.geojson') || fn.endsWith('.json')){
        try{ const gj=JSON.parse(await f.text()); addGeoJSON(f.name.replace(/\.(geo)?json$/i,''), gj); }
        catch{ alert('ÎœÎ· Î­Î³ÎºÏ…ÏÎ¿ GeoJSON: '+f.name); }
      } else if (fn.endsWith('.gpkg') && window.GeoPackage){
        try { await loadGPKG(f); } catch{ alert('Î ÏÏŒÎ²Î»Î·Î¼Î± Î¼Îµ GeoPackage: '+f.name); }
      } else {
        alert('Î¥Ï€Î¿ÏƒÏ„Î®ÏÎ¹Î¾Î·: GeoJSON (.geojson) Î® GeoPackage (.gpkg)');
      }
    }
  }

  async function loadGPKG(file){
    const arrayBuffer = await file.arrayBuffer();
    const gpkg = await window.GeoPackage.open(arrayBuffer);
    const tables = gpkg.getFeatureTables();
    if(!tables.length){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ feature layers ÏƒÏ„Î¿ GeoPackage.'); return; }
    for(const t of tables){
      const gj = gpkg.exportGeoJSON(t);
      addGeoJSON(`${file.name} â€” ${t}`, gj);
    }
  }

  // ---------- BASEMAP ----------
  elBasemap.addEventListener('change', e=>{
    map.removeLayer(basemaps[currentBase]); currentBase=e.target.value; basemaps[currentBase].addTo(map);
  });

  // ---------- STYLE PANEL ----------
  const sp = {
    el: document.getElementById('stylePanel'),
    title: document.getElementById('spTitle'),
    geom: document.getElementById('spGeom'),
    renderer: document.getElementById('renderer'),
    single: {
      fill: document.getElementById('fillColor'),
      stroke: document.getElementById('strokeColor'),
      width: document.getElementById('strokeWidth'),
      opacity: document.getElementById('opacity'),
      ptSize: document.getElementById('pointSize'),
      ptShape: document.getElementById('pointShape'),
    },
    field: {
      field: document.getElementById('fieldSelect'),
      palette: document.getElementById('paletteSelect'),
      classes: document.getElementById('classCount'),
      legend: document.getElementById('legendPreview'),
    },
    blocks: {
      single: document.getElementById('singleBlock'),
      field: document.getElementById('fieldBlock'),
      classes: document.getElementById('classesBlock'),
      palette: document.getElementById('paletteBlock'),
    },
    apply: document.getElementById('applyStyle'),
    reset: document.getElementById('resetStyle'),
    close: document.getElementById('spClose'),
    layerId: null
  };

  function openStylePanel(layerId){
    sp.layerId = layerId;
    const LYR = layers.find(x=>x.id===layerId);
    if(!LYR) return;
    sp.el.classList.add('active');
    sp.title.textContent = `Style â€” ${escapeHtml(LYR.name)}`;
    sp.geom.textContent = `Geometry: ${LYR.kind}`;
    sp.renderer.value = LYR.style.renderer;
    sp.single.fill.value = LYR.style.single.fill;
    sp.single.stroke.value = LYR.style.single.stroke;
    sp.single.width.value = LYR.style.single.width;
    sp.single.opacity.value = LYR.style.single.opacity;
    sp.single.ptSize.value = LYR.style.single.pointSize;
    sp.single.ptShape.value = LYR.style.single.pointShape;
    sp.field.field.innerHTML = '';
    const fs = LYR.fields;
    fs.forEach(f=>{
      const opt=document.createElement('option'); opt.value=f; opt.textContent=f; sp.field.field.appendChild(opt);
    });
    if(LYR.style.unique.field) sp.field.field.value = LYR.style.unique.field;
    if(LYR.style.graduated.field) sp.field.field.value = LYR.style.graduated.field;
    reflectRendererBlocks(LYR.style.renderer);
    rebuildLegendPreview(LYR);
  }
  function closeStylePanel(){ sp.el.classList.remove('active'); sp.layerId=null; }
  sp.close.onclick = closeStylePanel;

  function reflectRendererBlocks(mode){
    sp.blocks.single.style.display = (mode==='single')?'block':'none';
    sp.blocks.field.style.display = (mode!=='single')?'block':'none';
    sp.blocks.classes.style.display = (mode==='graduated')?'block':'none';
  }
  sp.renderer.addEventListener('change', e=> reflectRendererBlocks(e.target.value));

  function rebuildLegendPreview(LYR){
    const mode = sp.renderer.value;
    const legend = sp.field.legend; legend.innerHTML = '';
    if(mode==='single'){
      const s=LYR.style.single;
      const el=document.createElement('div'); el.className='item';
      el.innerHTML=`<span class="badge" style="background:${s.fill};border-color:${s.fill}"></span> Single`;
      legend.appendChild(el);
      return;
    }
    const field = sp.field.field.value;
    if(!field) return;
    const palette = PALETTES[sp.field.palette.value] || PALETTES.category10;
    const feats = (LYR.gj.features||[]);
    if(mode==='unique'){
      const uniq = [...new Set(feats.map(f=> String(f.properties?.[field])))].slice(0, palette.length);
      const items = uniq.map((v,i)=>({value:v,color:palette[i%palette.length]}));
      legend.dataset.items = JSON.stringify(items);
      items.forEach(it=>{
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<span class="badge" style="background:${it.color};border-color:${it.color}"></span> ${escapeHtml(it.value)}`;
        legend.appendChild(el);
      });
    } else if(mode==='graduated'){
      const k = Math.max(3, Math.min(9, Number(sp.field.classes.value)||5));
      const nums = feats.map(f=> Number(f.properties?.[field])).filter(x=>isFinite(x));
      legend.innerHTML = '';
      if(nums.length===0){ return; }
      const br = quantiles(nums, k);
      const cols = (PALETTES[sp.field.palette.value]||PALETTES.viridis);
      const grad = Array.from({length:k},(_,i)=> cols[Math.floor(i*(cols.length-1)/(k-1))]);
      legend.dataset.breaks = JSON.stringify(br);
      legend.dataset.colors = JSON.stringify(grad);
      const bounds = [Math.min(...nums), ...br, Math.max(...nums)];
      for(let i=0;i<k;i++){
        const label = `${bounds[i].toFixed(2)} â€“ ${bounds[i+1].toFixed(2)}`;
        const el=document.createElement('div'); el.className='item';
        el.innerHTML=`<span class="badge" style="background:${grad[i]};border-color:${grad[i]}"></span> ${label}`;
        legend.appendChild(el);
      }
    }
  }
  sp.field.field.addEventListener('change', ()=> {
    const LYR = layers.find(x=>x.id===sp.layerId); if(!LYR) return;
    rebuildLegendPreview(LYR);
  });
  sp.field.palette.addEventListener('change', ()=> {
    const LYR = layers.find(x=>x.id===sp.layerId); if(!LYR) return;
    rebuildLegendPreview(LYR);
  });
  sp.field.classes.addEventListener('input', ()=> {
    const LYR = layers.find(x=>x.id===sp.layerId); if(!LYR) return;
    rebuildLegendPreview(LYR);
  });

  sp.apply.onclick = ()=>{
    const LYR = layers.find(x=>x.id===sp.layerId); if(!LYR) return;
    const mode = sp.renderer.value;
    LYR.style.renderer = mode;
    if(mode==='single'){
      Object.assign(LYR.style.single, {
        fill: sp.single.fill.value,
        stroke: sp.single.stroke.value,
        width: Number(sp.single.width.value)||2,
        opacity: Number(sp.single.opacity.value)||0.75,
        pointSize: Number(sp.single.ptSize.value)||10,
        pointShape: sp.single.ptShape.value
      });
    } else {
      const field = sp.field.field.value;
      if(!field){ alert('Î”Î¹Î¬Î»ÎµÎ¾Îµ Ï€ÎµÎ´Î¯Î¿ Î³Î¹Î± Unique/Graduated.'); return; }
      const feats = (LYR.gj.features||[]);
      const vals = feats.map(f=> f?.properties?.[field]).filter(v=> v!==undefined && v!==null);
      if(mode==='unique'){
        if(vals.length===0){ alert('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï„Î¹Î¼Î­Ï‚ ÏƒÏ„Î¿ Ï€ÎµÎ´Î¯Î¿.'); return; }
        const items = JSON.parse(sp.field.legend.dataset.items||'[]');
        LYR.style.unique.field = field;
        LYR.style.unique.palette = sp.field.palette.value;
        LYR.style.unique.legend = items;
      } else if(mode==='graduated'){
        const nums = vals.map(Number).filter(x=>isFinite(x));
        if(nums.length===0){ alert('Î“Î¹Î± Graduated Ï‡ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Î±ÏÎ¹Î¸Î¼Î·Ï„Î¹ÎºÎ­Ï‚ Ï„Î¹Î¼Î­Ï‚.'); return; }
        const breaks = JSON.parse(sp.field.legend.dataset.breaks||'[]');
        const colors = JSON.parse(sp.field.legend.dataset.colors||'[]').map((c,i)=>({i,color:c}));
        LYR.style.graduated.field = field;
        LYR.style.graduated.classes = Number(sp.field.classes.value)||5;
        LYR.style.graduated.palette = sp.field.palette.value;
        LYR.style.graduated.breaks = breaks;
        LYR.style.graduated.legend = colors;
      }
    }
    map.removeLayer(LYR.leaflet);
    LYR.leaflet = buildLeaflet(LYR);
    if(LYR.visible) LYR.leaflet.addTo(map);
    closeStylePanel();
  };
  sp.reset.onclick = ()=>{
    const LYR = layers.find(x=>x.id===sp.layerId); if(!LYR) return;
    LYR.style = defaultStyle(LYR.kind);
    map.removeLayer(LYR.leaflet);
    LYR.leaflet = buildLeaflet(LYR);
    if(LYR.visible) LYR.leaflet.addTo(map);
    openStylePanel(LYR.id);
  };

  // ---------- ATTRIBUTE TABLE ----------
  const __fidToFeature = new Map();
  function zoomToFeature(feat){
    try{
      if(!feat) return;
      const t = feat.geometry?.type || '';
      if(/Point$/.test(t)){
        const [lng,lat] = feat.geometry.coordinates;
        map.setView([lat,lng], Math.max(map.getZoom(), 14));
        return;
      }
      const tmp = L.geoJSON(feat);
      const b = tmp.getBounds();
      if(b && b.isValid()){ map.fitBounds(b, { padding:[24,24], maxZoom: 16 }); }
      tmp.remove && tmp.remove();
    }catch{}
  }
  function augmentAttrTableWithZoom(){
    const table = document.getElementById('attrwin-table');
    if(!table) return;
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    if(!thead || !tbody) return;

    const headers = Array.from(thead.querySelectorAll('th'));
    const names = headers.map(h=>h.textContent.trim());
    let fidIdx = names.indexOf('__fid');
    if(fidIdx >= 0){ headers[fidIdx].style.display='none'; }
    if(names.indexOf('Actions') === -1){
      const th = document.createElement('th'); th.textContent = 'Actions';
      thead.querySelector('tr').appendChild(th);
    }
    Array.from(tbody.querySelectorAll('tr')).forEach(tr=>{
      if(tr.dataset.zoomAugmented === '1') return;
      const cells = Array.from(tr.children);
      if(fidIdx >= 0 && cells[fidIdx]) cells[fidIdx].style.display='none';
      const fid = (fidIdx >= 0 && cells[fidIdx]) ? cells[fidIdx].textContent.trim() : null;
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm';
      btn.textContent = 'ğŸ” Zoom';
      btn.title = 'Zoom to feature';
      btn.addEventListener('click', (e)=>{ e.stopPropagation(); if(fid) zoomToFeature(__fidToFeature.get(fid)); });
      td.appendChild(btn);
      tr.appendChild(td);
      tr.dataset.zoomAugmented = '1';
    });
  }
  const __observer = new MutationObserver(()=> augmentAttrTableWithZoom());
  __observer.observe(document.getElementById('attrwin'), { subtree:true, childList:true });

  function openAttrTable(layerId){
    const LYR = layers.find(x=>x.id===layerId);
    if(!LYR) return;
    const feats = (LYR.gj.features||[]);
    __fidToFeature.clear();
    const rows = feats.map((f,i)=>{
      const fid = (f.id!=null ? String(f.id) : String(i+1));
      __fidToFeature.set(fid, f);
      return { __fid: fid, id: f.id ?? (i+1), ...f.properties };
    });
    window.openAttrWindow(rows, { title: `Attributes â€¢ ${escapeHtml(LYR.name)}` });
    const cntEl = document.getElementById('attrwin-count');
    if(cntEl) cntEl.textContent = `Rows: ${rows.length}`;
    const srch = document.getElementById('attrwin-search');
    if(srch && !srch.__enterBound){
      srch.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); srch.blur(); }});
      srch.__enterBound = true;
    }
    setTimeout(augmentAttrTableWithZoom, 0);
  }

// ---------- CUSTOM SCALE BAR (bottom-left: labels Ï€Î¬Î½Ï‰, bar + "Km" Î´ÎµÎ¾Î¹Î¬) ----------
function pickNice(m) {
  const base = [1, 2, 5];
  let scale = 1;
  while (true) {
    for (const b of base) {
      const val = b * scale;
      if (val >= m) return val;
    }
    scale *= 10;
  }
}

function formatMeters(m, unit = true) {
  if (m >= 1000) {
    const km = m / 1000;
    let txt = parseFloat(km.toFixed(2)).toString();
    return unit ? `${txt} Km` : txt;
  } else if (m >= 10) {
    // Î“Î¹Î± Î¼Î­Ï„ÏÎ± Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ 10, Î´ÎµÎ¯Î¾Îµ Î­Ï‰Ï‚ 1 Î´ÎµÎºÎ±Î´Î¹ÎºÏŒ (Ï€.Ï‡. 12.5)
    let txt = parseFloat(m.toFixed(1)).toString();
    return unit ? `${txt} m` : txt;
  } else {
    // Î“Î¹Î± Ï€Î¿Î»Ï Î¼Î¹ÎºÏÎ­Ï‚ Ï„Î¹Î¼Î­Ï‚, ÎºÏÎ¬Ï„Î± 2 Î´ÎµÎºÎ±Î´Î¹ÎºÎ¬
    let txt = parseFloat(m.toFixed(2)).toString();
    return unit ? `${txt} m` : txt;
  }
}

const ScaleControl = L.Control.extend({
  options: { position: 'bottomleft' },

  onAdd: function () {
    const div = L.DomUtil.create('div', 'leaflet-control scale-control');
    // labels ÎµÏ€Î¬Î½Ï‰
    this._labels = L.DomUtil.create('div', 'scale-labels', div);
    // ÏƒÎµÎ¹ÏÎ¬: Î¼Ï€Î¬ÏÎ± + Î¼Î¿Î½Î¬Î´Î± Î´ÎµÎ¾Î¹Î¬
    this._row = L.DomUtil.create('div', '', div);
    this._row.style.display = 'flex';
    this._row.style.alignItems = 'center';
    this._row.style.gap = '6px';

    this._bar = L.DomUtil.create('div', 'scale-bar', this._row);
    this._bar.style.position = 'relative';

    // Î¼Î¿Î½Î¬Î´Î± Î´ÎµÎ¾Î¹Î¬ (Ï€Î¬Î½Ï„Î± Î¼Î±ÏÏÎ·)
    this._unit = L.DomUtil.create('div', 'scale-unit', this._row);
    this._unit.style.fontSize = '12px';
    this._unit.style.color = '#000';
    this._unit.style.userSelect = 'none';
    this._unit.style.fontWeight = 'normal';

    this.update();
    map.on('move zoom', () => this.update());
    return div;
  },

  update() {
    const R = 6378137;
    const lat = map.getCenter().lat * Math.PI / 180;
    const mPerPx = Math.cos(lat) * 2 * Math.PI * R / (256 * Math.pow(2, map.getZoom()));

    const minPx = 180;
    const maxPx = 220;
    const targetPx = 200;

    const minMeters = mPerPx * minPx;
    const maxMeters = mPerPx * maxPx;

    if (!isFinite(minMeters) || minMeters <= 0) return;

    const bases = [1, 2, 5];
    const candidates = [];
    const minExp = Math.floor(Math.log10(minMeters)) - 1;
    const maxExp = Math.ceil(Math.log10(maxMeters)) + 1;

    for (let e = minExp; e <= maxExp; e++) {
      const factor = Math.pow(10, e);
      for (const b of bases) {
        const val = b * factor;
        if (val >= minMeters && val <= maxMeters) {
          candidates.push(val);
        }
      }
    }

    if (!candidates.length) return;

    const targetMeters = mPerPx * targetPx;
    let best = candidates[0];
    let bestScore = Math.abs(Math.log(best / targetMeters));

    for (const v of candidates) {
      const s = Math.abs(Math.log(v / targetMeters));
      if (s < bestScore) {
        best = v;
        bestScore = s;
      }
    }

    const nice = best;
    const px = nice / mPerPx;

this._bar.style.width = `${px}px`;
this._bar.style.height = '10px';
this._bar.style.border = '1px solid #000';
this._bar.style.borderRadius = '6px';
this._bar.style.overflow = 'hidden';

this._bar.style.background =
  'linear-gradient(90deg,' +
    '#000 0, #000 25%,' +
    '#fff 25%, #fff 50%,' +
    '#000 50%, #000 100%' +
  ')';

    this._labels.innerHTML = '';
    this._labels.style.position = 'relative';
    this._labels.style.width = `${px - 2}px`;
    this._labels.style.marginLeft = '1px';
    this._labels.style.height = '14px';
    this._labels.style.marginBottom = '2px';

    const ticks = [
      { pos: 0,    val: 0 },
      { pos: 0.25, val: nice * 0.25 },
      { pos: 0.5,  val: nice * 0.5 },
      { pos: 1,    val: nice }
    ];

    for (const t of ticks) {
      const div = document.createElement('div');
      div.style.position = 'absolute';
      div.style.left = `${t.pos * 100}%`;

      if (t.pos === 0) {
        div.style.transform = 'translateX(0%)';
        div.style.textAlign = 'left';
      } else if (t.pos === 1) {
        div.style.transform = 'translateX(-100%)';
        div.style.textAlign = 'right';
      } else {
        div.style.transform = 'translateX(-50%)';
        div.style.textAlign = 'center';
      }

      div.textContent = formatMeters(t.val, false);
      this._labels.appendChild(div);
    }

    this._unit.textContent = nice >= 1000 ? 'Km' : 'm';
  }
});

// ÎµÎ´Ï Ï€Î»Î­Î¿Î½:
const scaleCtl = new ScaleControl();
map.addControl(scaleCtl);

  // ---------- MEASURE + SCALE INPUT + LOCK (TopRight Bar) ----------
  function mPerPxAt(lat, zoom){
    const R = 6378137; // meters
    return Math.cos(lat*Math.PI/180) * 2 * Math.PI * R / (256 * Math.pow(2, zoom));
  }
  function zoomForDenom(lat, denom){
    const R = 6378137;
    const DPI = (window.devicePixelRatio || 1) * 96;
    const K = Math.cos(lat*Math.PI/180) * 2 * Math.PI * R * (DPI/0.0254) / 256;
    const z = Math.log2(K / denom);
    return Math.max(map.getMinZoom() ?? 0, Math.min(map.getMaxZoom() ?? 19, z));
  }
  function parseScaleInput(s){
    if(!s) return null;
    s = String(s).trim().toLowerCase().replace(/^1\s*:\s*/,'');
    s = s.replace(/[.\s,]/g,'');
    if(/k$/.test(s)) s = String(parseFloat(s)*1000);
    if(/m$/.test(s)) s = String(parseFloat(s)*1_000_000);
    const n = Number(s);
    if(!isFinite(n) || n<=0) return null;
    return n;
  }

 const TopBarControl = L.Control.extend({
  options: { position: 'bottomright' },
  onAdd: function(){
    const bar = L.DomUtil.create('div','topbar leaflet-control');
    const fsContainer = map.getContainer();   // Î³Î¹Î± fullscreen

    // scale box (Î±ÏÎ¹ÏƒÏ„ÎµÏÎ¬ Î±Ï€ÏŒ measure)
    const scaleBox = L.DomUtil.create('div','scalebox', bar);
    const lbl = L.DomUtil.create('label','', scaleBox);
    lbl.htmlFor = 'scaleInput'; lbl.textContent = '1:';
    const inp = L.DomUtil.create('input','', scaleBox);
    inp.id='scaleInput'; inp.type='text'; inp.placeholder='5000';
    const go  = L.DomUtil.create('button','', scaleBox);
    go.id='scaleGo'; go.type='button'; go.textContent='Go';
    const lock = L.DomUtil.create('button','', scaleBox);
    lock.id='scaleLock'; lock.type='button'; lock.textContent='Lock';

    // measure group (Î´ÎµÎ¾Î¹Î¬)
    const mwrap = L.DomUtil.create('div','measure-tools', bar);
    const mkBtn = (label, iconTxt) => {
      const a = L.DomUtil.create('a','',mwrap);
      a.href='#';
      a.innerHTML = `<span class="ico" aria-hidden="true">${iconTxt}</span>`;
      a.title = label; a.setAttribute('aria-label', label);
      return a;
    };

    const btnDist  = mkBtn(
      'Measure line (click to add points â€¢ double click to finish â€¢ Esc to cancel)',
      'ğŸ“'
    );
    const btnArea  = mkBtn(
      'Measure area (click to add vertices â€¢ double click to finish â€¢ Esc to cancel)',
      'â–±'
    );
    const btnClear = mkBtn('Clear all measurements','ğŸ§¹');
    const btnFull  = mkBtn('Toggle fullscreen','â›¶');  // ÎÎ•ÎŸ fullscreen

    function setActive(b){
      [btnDist,btnArea].forEach(el=> el.classList.remove('active'));
      b && b.classList.add('active');
    }
    btnDist.addEventListener('click',(ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      setActive(btnDist); startMeasure('distance');
    });
    btnArea.addEventListener('click',(ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      setActive(btnArea); startMeasure('area');
    });
    btnClear.addEventListener('click',(ev)=>{
      ev.preventDefault(); ev.stopPropagation();
      setActive(null); clearAllMeasurements();
    });

    // --- Fullscreen toggle ---
    function syncFsState(){
      const active = document.fullscreenElement === fsContainer;
      btnFull.classList.toggle('active', active);
    }

    btnFull.addEventListener('click',(ev)=>{
      ev.preventDefault();
      ev.stopPropagation();
      if (document.fullscreenElement === fsContainer){
        if (document.exitFullscreen) document.exitFullscreen();
      } else {
        if (fsContainer.requestFullscreen){
          fsContainer.requestFullscreen();
        }
      }
    });

    document.addEventListener('fullscreenchange', () => {
      syncFsState();
      map.invalidateSize();   // ğŸ‘ˆ Î³Î¹Î± Î½Î± Ï€ÏÎ¿ÏƒÎ±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹ ÏƒÏ‰ÏƒÏ„Î¬ Î¿ Ï‡Î¬ÏÏ„Î·Ï‚ fullscreen/exit
    });
    syncFsState();

    // -------------------------

    // scale handlers
    function applyScale(){
      const n = parseScaleInput(inp.value);
      if(!n){
        alert('Î”ÏÏƒÎµ Î­Î³ÎºÏ…ÏÎ· ÎºÎ»Î¯Î¼Î±ÎºÎ± Ï€.Ï‡. 5000, 1:25000, 10k, 1:2m');
        return;
      }
      const lat = map.getCenter().lat;
      const z = zoomForDenom(lat, n);
      map.setZoom(z);
    }
    go.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation(); applyScale();
    });
    inp.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){
        e.preventDefault(); e.stopPropagation(); applyScale();
      }
    });

    // lock (Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹ÎµÎ¯ ÏÎ¿Î´Î­Î»Î±/Î±Ï†Î® Î³Î¹Î± Î½Î± Î¼Î·Î½ Î±Î»Î»Î¬Î¶ÎµÎ¹ Î· ÎºÎ»Î¯Î¼Î±ÎºÎ±)
let isLocked = false;
function setLock(on){
  isLocked = !!on;
  zoomLocked = isLocked;                      // ğŸ”’ ÎµÎ½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿ global flag
  lock.classList.toggle('active', isLocked);

  const container = map.getContainer();

  if (isLocked){
    map.scrollWheelZoom.disable();
    map.touchZoom.disable();
    map.boxZoom.disable();
    map.keyboard.disable();
    map.doubleClickZoom.disable();

    container.classList.add('zoom-locked');
  } else {
    map.scrollWheelZoom.enable();
    map.touchZoom.enable();
    map.boxZoom.enable();
    map.keyboard.enable();
    map.doubleClickZoom.enable();

    container.classList.remove('zoom-locked');
  }
}



    lock.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation(); setLock(!isLocked);
    });

    L.DomEvent.disableClickPropagation(bar);
    return bar;
  }
});

  map.addControl(new TopBarControl());  // â† measure + scale (Ï€Î¬Î½Ï‰ Î´ÎµÎ¾Î¹Î¬)
  map.addControl(new NorthControl());   // â† Î²ÏŒÏÏÎ±Ï‚ Î±ÎºÏÎ¹Î²ÏÏ‚ Î±Ï€ÏŒ ÎºÎ¬Ï„Ï‰


  // ---------- MEASURE CORE ----------
  const measureLayer = L.featureGroup().addTo(map);
  let measureMode = null, pts = [], sketch = null, ghost = null, finishing = false;
  const mapEl = map.getContainer();
  const hud = document.createElement('div'); hud.id='measureHud'; mapEl.appendChild(hud);
  let isMeasuring = false;

  function enablePanOnlyWithMiddleButton(){
    if(!mapEl.__measureMouseDownBound){
      mapEl.addEventListener('mousedown', (e)=>{
        if(!isMeasuring) return;
        if(e.button === 1){ map.dragging.enable(); } else { map.dragging.disable(); }
      }, true);
      mapEl.__measureMouseDownBound = true;
    }
    if(!mapEl.__measureMouseUpBound){
      mapEl.addEventListener('mouseup', ()=>{
        if(!isMeasuring) return;
        map.dragging.disable();
      }, true);
      mapEl.__measureMouseUpBound = true;
    }
    if(!mapEl.__measureCtxMenuBound){
      mapEl.addEventListener('contextmenu', (e)=>{
        if(!isMeasuring) return;
        e.preventDefault();
      });
      mapEl.__measureCtxMenuBound = true;
    }
  }
  enablePanOnlyWithMiddleButton();

  function setCursor(active){ mapEl.style.cursor = active ? 'crosshair' : ''; }
  function kmFmt(km){ return (km >= 1) ? `${km.toFixed(2)} km` : `${(km*1000).toFixed(0)} m`; }
  function areaFmt(m2){
    if(m2 >= 1e6) return `${(m2/1e6).toFixed(2)} kmÂ²`;
    if(m2 >= 1e4) return `${(m2/1e4).toFixed(2)} ha`;
    return `${m2.toFixed(0)} mÂ²`;
  }
  function clearGhost(){ if(ghost){ measureLayer.removeLayer(ghost); ghost=null; } }
  function clearSketch(){ if(sketch){ measureLayer.removeLayer(sketch); sketch=null; } }
  function stopHUD(){ hud.style.display='none'; hud.textContent=''; }
  function moveHUD(e){
    const rect = mapEl.getBoundingClientRect();
    const ev = e.originalEvent || e;
    hud.style.left = (ev.clientX - rect.left) + 'px';
    hud.style.top  = (ev.clientY - rect.top) + 'px';
  }

  function updateGhost(latlng){
    if(!measureMode || pts.length===0) return;
    clearGhost();
    const path = [...pts.map(([lng,lat])=>[lat,lng]), [latlng.lat, latlng.lng]];
    if(measureMode==='distance'){
      ghost = L.polyline(path, { color:'#00d3a7', weight:2, opacity:0.9, className:'measure-ghost-line', interactive:false });
      const line = turf.lineString([...pts, [latlng.lng, latlng.lat]]);
      const lenKm = turf.length(line, {units:'kilometers'});
      hud.textContent = `Length: ${kmFmt(lenKm)}`;
      hud.style.display='block';
    }else{
      ghost = L.polygon(path, { color:'#6aa6ff', weight:2, fillOpacity:.06, className:'measure-ghost-line', interactive:false });
      if(pts.length>=2){
        const poly = turf.polygon([[...pts, [latlng.lng, latlng.lat], pts[0]]]);
        const a = turf.area(poly);
        hud.textContent = `Area: ${areaFmt(a)}`;
        hud.style.display='block';
      }else{
        hud.style.display='none';
      }
    }
    ghost.addTo(measureLayer);
  }

  function updateSketch(){
    if(!pts.length) return;
    clearSketch();
    if(measureMode==='distance'){
      sketch = L.polyline(pts.map(([lng,lat])=>[lat,lng]), {color:'#00d3a7',weight:3,interactive:false});
    }else if(measureMode==='area'){
      sketch = L.polygon(pts.map(([lng,lat])=>[lat,lng]), {color:'#6aa6ff',weight:2,fillOpacity:.1,interactive:false});
    }
    sketch && sketch.addTo(measureLayer);
  }

  function startMeasure(mode){
    cancelMeasure();
    measureMode = mode; pts = [];
    setCursor(true);
    finishing = false;
    hud.style.display='block';
    isMeasuring = true;
    map.dragging.disable();
    map.on('mousemove', onMouseMove);
  }

  function bindResultClick(layer, latlng, content){
    layer._measure = { latlng, content };
    layer.on('click', ()=>{
      const m = layer._measure;
      if(!m) return;
      L.popup({ closeButton:true })
        .setLatLng(m.latlng)
        .setContent(m.content)
        .openOn(map);
    });
  }

  function finishMeasure(){
    if(finishing) return;
    finishing = true;
    if(!pts.length){ cancelMeasure(); finishing=false; return; }

    let resultLayer = null, latlngForPopup = null, html = '';

    if(measureMode==='distance' && pts.length>=2){
      const line = turf.lineString(pts);
      const lenKm = turf.length(line, {units:'kilometers'});
      const mid = turf.along(line, lenKm/2, {units:'kilometers'}).geometry.coordinates;
      latlngForPopup = L.latLng(mid[1], mid[0]);
      html = `<strong>Length</strong><br>${kmFmt(lenKm)}`;
      resultLayer = L.polyline(pts.map(([lng,lat])=>[lat,lng]), {color:'#00d3a7',weight:3,interactive:true});
    }else if(measureMode==='area' && pts.length>=3){
      const poly = turf.polygon([[...pts, pts[0]]]);
      const a = turf.area(poly);
      const c = turf.centroid(poly).geometry.coordinates;
      latlngForPopup = L.latLng(c[1], c[0]);
      html = `<strong>Area</strong><br>${areaFmt(a)}`;
      resultLayer = L.polygon(pts.map(([lng,lat])=>[lat,lng]), {color:'#6aa6ff',weight:2,fillOpacity:.1,interactive:true});
    }

    clearGhost(); clearSketch();
    if(resultLayer){
      resultLayer.addTo(measureLayer);
      L.popup({ closeButton:true })
        .setLatLng(latlngForPopup)
        .setContent(html)
        .openOn(map);
      bindResultClick(resultLayer, latlngForPopup, html);
    }

    stopHUD(); setCursor(false);
    measureMode = null; pts = [];
    isMeasuring = false;
    map.dragging.enable();
    setTimeout(()=> { finishing = false; }, 120);
    map.off('mousemove', onMouseMove);
  }

  function cancelMeasure(){
    pts = []; clearGhost(); clearSketch(); stopHUD();
    setCursor(false); measureMode = null; finishing = false;
    map.off('mousemove', onMouseMove); isMeasuring = false; map.dragging.enable();
  }

  function clearAllMeasurements(){
    cancelMeasure(); measureLayer.clearLayers(); map.closePopup();
  }

  function onMouseMove(e){ if(!measureMode) return; moveHUD(e); updateGhost(e.latlng); }

  map.on('click', (e)=>{
    if(!measureMode) return;
    if(e.originalEvent && e.originalEvent.detail > 1) return;
    const ll = e.latlng; pts.push([ll.lng, ll.lat]); updateSketch();
  });

  if(!mapEl.__dblFinishBound){
    mapEl.addEventListener('dblclick', (ev)=>{
      if(!measureMode) return;
      ev.preventDefault(); ev.stopPropagation();
      const ll = map.mouseEventToLatLng(ev);
      const cur = [ll.lng, ll.lat];
      const last = pts[pts.length-1];
      const isSame = last && map.distance(L.latLng(last[1],last[0]), ll) < 2;
      if(!isSame) pts.push(cur);
      updateSketch(); finishMeasure();
    }, true);
    mapEl.__dblFinishBound = true;
  }

  L.DomEvent.on(document, 'keydown', (e)=>{ if(e.key==='Escape') cancelMeasure(); });

  // ---------- COMPACT HELPERS ----------
  function round6(n){ return Math.round(n*1e5)/1e5; }
  function processCoords(coords){
    if (typeof coords[0] === 'number'){
      if (coords.length === 2) return [round6(coords[0]), round6(coords[1])];
      if (coords.length >= 3) return [round6(coords[0]), round6(coords[1]), round6(coords[2])];
    }
    return coords.map(processCoords);
  }
  function compactGeometry(geom){
    if(!geom) return geom;
    const { type, coordinates } = geom;
    if(!coordinates) return geom;
    return { type, coordinates: processCoords(coordinates) };
  }
  function stripEmpty(obj){
    if (obj == null) return obj;
    const out = {};
    for (const [k,v] of Object.entries(obj)){
      if (v === null || v === undefined) continue;
      out[k] = v;
    }
    return out;
  }
  function compactFeature(feat){
    return { type: 'Feature', id: feat.id, properties: stripEmpty(feat.properties || {}), geometry: compactGeometry(feat.geometry) };
  }
  function compactGeoJSON(fc){
    const feats = (fc.features || []).map(compactFeature);
    return { type:'FeatureCollection', features:feats };
  }
  function byteLen(str){ return new Blob([str]).size; }

  // ---------- GENERATE LINK ----------
  document.getElementById('btnGenerate').addEventListener('click', async ()=>{
    const openShare = window.__openShareWindow;
    const shareInput = document.getElementById('sharewin-url');
    const shareStatus = document.getElementById('sharewin-status');
    const shareCopy = document.getElementById('sharewin-copy');
    const btn = document.getElementById('btnGenerate');

    function setBusy(on){
      btn.disabled = !!on;
      btn.textContent = on ? 'Generatingâ€¦' : 'Generate Link';
    }
    function setShareBusy(on, msg){
      if(!shareInput || !shareCopy || !shareStatus) return;
      if(on){
        shareInput.value = '';
        shareInput.placeholder = 'Generatingâ€¦';
        shareCopy.disabled = true;
        shareStatus.textContent = msg || 'Generatingâ€¦';
      }else{
        shareInput.placeholder = 'Linkâ€¦';
        shareCopy.disabled = false;
        shareStatus.textContent = msg || '';
      }
    }

    try{
      if(openShare) openShare('');
      setShareBusy(true, 'Generatingâ€¦');
      setBusy(true);

      if(layers.length === 0){
        setBusy(false); setShareBusy(false);
        alert('Î ÏÏŒÏƒÎ¸ÎµÏƒÎµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ 1 layer Î³Î¹Î± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î·Î¸ÎµÎ¯ link.');
        return;
      }
      if(layers.length > 3){
        setBusy(false); setShareBusy(false);
        alert('ÎœÎ­Î³Î¹ÏƒÏ„Î¿ 3 layers (free). Î’Î³Î¬Î»Îµ ÎºÎ¬Ï€Î¿Î¹Î± ÎºÎ±Î¹ Î¾Î±Î½Î±Ï€ÏÎ¿ÏƒÏ€Î¬Î¸Î·ÏƒÎµ.');
        return;
      }

      const state = {
        title: document.getElementById('title').value || 'Untitled',
        description: document.getElementById('desc').value || '',
        basemap: currentBase,
        center: { lat: map.getCenter().lat, lng: map.getCenter().lng },
        zoom: map.getZoom(),
        layers: layers.map(L=>({
          name: L.name,
          gj: compactGeoJSON(L.gj),
          visible: L.visible,
          kind: L.kind,
          style: L.style
        }))
      };

      const payloadPreview = JSON.stringify({ ...state, ttlDays: 7 });
      const size = byteLen(payloadPreview);
      if (size > 10_000_000) {
        const perLayer = state.layers.map((L,i) => ({
          i: i+1,
          name: L.name,
          features: (L.gj.features || []).length,
        }));
        setBusy(false); setShareBusy(false);
        alert(
          `Î¤Î¿ payload ÎµÎ¯Î½Î±Î¹ Ï€Î¿Î»Ï Î¼ÎµÎ³Î¬Î»Î¿ (${(size/1e6).toFixed(2)} MB > 10.00 MB).\n` +
          `ÎœÎµÎ¯Ï‰ÏƒÎµ features/Î±Ï€Î»Î¿ÏÏƒÏ„ÎµÏ…ÏƒÎµ Î³ÎµÏ‰Î¼ÎµÏ„ÏÎ¯ÎµÏ‚ Î® ÏƒÏ€Î¬ÏƒÎµ ÏƒÎµ 2 links.\n\n` +
          `Layers:\n` + perLayer.map(r=>`#${r.i} ${r.name} â€” ${r.features} features`).join('\n')
        );
        return;
      }

      const r = await fetch('/api/stories', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ ...state, ttlDays: 7 })
      });

      const text = await r.text();
      let data = {};
      try{ data = JSON.parse(text); }catch{}

      if(!r.ok){
        setBusy(false); setShareBusy(false);
        const msg = data.error || data.message || text || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿ ÏƒÏ†Î¬Î»Î¼Î±';
        if(r.status === 403){
          alert('403: Editor/API ÎµÎ¯Î½Î±Î¹ ÎºÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿ Î³Î¹Î± Ï„Î¿Ï€Î¹ÎºÎ® Ï‡ÏÎ®ÏƒÎ·.\n' +
                'Î£Îµ Render Î²Î¬Î»Îµ ALLOW_EDITOR_NETWORK=1 Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚ Î´Î·Î¼ÏŒÏƒÎ¹Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·.\n\nÎ›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹Î±: ' + msg);
        } else if (r.status === 413){
          alert('413: State too large. Î‘Ï€Î»Î¿ÏÏƒÏ„ÎµÏ…ÏƒÎµ Î³ÎµÏ‰Î¼ÎµÏ„ÏÎ¯ÎµÏ‚ Î® ÏƒÏ€Î¬ÏƒÎµ Ï„Î¿ Î­ÏÎ³Î¿ ÏƒÎµ 2 links.');
        } else {
          alert(`Î£Ï†Î¬Î»Î¼Î± ${r.status}: ${msg}`);
        }
        return;
      }

      const link = (location.origin + (data.url || `/s/${data.id}`));
      if(shareInput){
        shareInput.value = link;
        setShareBusy(false, 'Ready â€” Copy to clipboard');
      }
      setBusy(false);
    }catch(e){
      setBusy(false); setShareBusy(false);
      alert('Î£Ï†Î¬Î»Î¼Î± Î´Î¹ÎºÏ„ÏÎ¿Ï…: ' + (e?.message || e));
    }
  });

  // ESC ÎºÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿ panels
  document.addEventListener('keydown',(e)=>{
    if(e.key!=='Escape') return;
    const spEl = document.getElementById('stylePanel');
    if(spEl && spEl.classList.contains('active')){ document.getElementById('spClose')?.click(); return; }
    const sh = document.getElementById('sharewin');
    if(sh && !sh.classList.contains('hidden')){ document.getElementById('sharewin-close')?.click(); return; }
    const attr = document.getElementById('attrwin');
    if(attr && !attr.classList.contains('hidden')){ document.getElementById('attrwin-close')?.click(); }
  });
</script>
</body>
</html>
