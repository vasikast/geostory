<!DOCTYPE html>
<html lang="el" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoVisual Stories — Editor</title>

<!-- Preconnect to tile servers to reduce latency -->
<link rel="preconnect" href="https://tile.openstreetmap.org" crossorigin>
<link rel="preconnect" href="https://server.arcgisonline.com" crossorigin>
<link rel="preconnect" href="https://unpkg.com" crossorigin>

<!-- Leaflet -->
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin="" />
<script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<!-- (Προαιρετικά) GeoPackage reader για browser -->
<script defer src="https://unpkg.com/@ngageoint/geopackage/dist/geopackage.min.js"></script>

<!-- Turf.js για μετρήσεις -->
<script defer src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

<!-- Attribute/Share Window styles -->
<link rel="stylesheet" href="/public/css/attrwin.css?v=4" />

<style>
  /* THEME VARIABLES */
  :root{
    --bg:#f7f8fc; --panel:#ffffff; --card:#ffffff; --text:#0b1020;
    --muted:#5a678a; --line:#e6e8f2; --acc:#3b82f6; --acc2:#10b981;
    --chip:#eef2ff; --chip-border:#dbe5ff;
  }
  :root[data-theme="dark"]{
    --bg:#0b1020; --panel:#0f1630; --card:#0d1430; --text:#e8ecff;
    --muted:#9fb0e0; --line:#24324f; --acc:#6aa6ff; --acc2:#00d3a7;
    --chip:#12215c; --chip-border:#2b3c6a;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  a{color:var(--acc)}
  .wrap{display:grid;grid-template-columns:380px 1fr;grid-template-rows:auto 1fr;gap:12px;min-height:100vh;padding:12px}
  header{grid-column:1/-1;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px 14px;display:flex;align-items:center;gap:10px}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:28px;height:28px;border-radius:8px;background:linear-gradient(135deg,var(--acc),var(--acc2));box-shadow:0 0 0 1px #0002}
  h1{font-size:18px;margin:0}
  .actions{margin-left:auto;display:flex;gap:8px}
  .btn{background:#1a2448;border:1px solid #2b3c6a;color:#fff;padding:9px 12px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}
  .btn.primary{background:var(--acc);border-color:#4d88db;color:#081226}
  .btn.btn-sm{padding:6px 10px;font-size:12px}
  .sidebar{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:12px;overflow:auto}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .card h3{margin:0 0 8px 0;font-size:14px;color:var(--text)}
  label{font-size:13px;color:var(--text);display:block;margin:8px 0 6px}
  input[type="text"], textarea, select, input[type="number"], input[type="color"], input[type="search"]{
    width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);font-size:14px
  }
  textarea{min-height:80px;resize:vertical}
  .muted{color:var(--muted);font-size:12px}
  .dropzone{border:2px dashed var(--line);border-radius:12px;padding:14px;text-align:center;color:var(--muted);background:color-mix(in oklab, var(--panel) 90%, transparent)}
  .dropzone.dragover{border-color:var(--acc);color:var(--text);background:color-mix(in oklab, var(--panel) 70%, var(--acc) 10%)}
  .layers{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto}
  .layer{display:flex;justify-content:space-between;align-items:center;gap:8px;background:color-mix(in oklab, var(--panel) 85%, transparent);border:1px solid var(--line);border-radius:12px;padding:8px}
  .layer .meta{display:flex;flex-direction:column}
  .layer .meta small{color:var(--muted)}
  .canvas{border:1px solid var(--line);border-radius:16px;overflow:hidden}
  #map{position:relative;height:100%;min-height:70vh;background:#0a0f1e}

  /* Leaflet controls (generic) */
  .leaflet-control-attribution,
  .leaflet-bar a, .leaflet-bar a:hover{
    background: color-mix(in oklab, var(--panel) 85%, transparent);
    color: var(--muted);
    border-color: var(--line);
  }
  .leaflet-bar a{ color: var(--text); }

  /* Style panel */
  .style-panel{display:none;position:fixed;right:16px;top:16px;width:360px;max-height:90vh;overflow:auto;background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 8px 30px rgba(0,0,0,.18)}
  .style-panel.active{display:block}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  .legend{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
  .legend .item{display:flex;align-items:center;gap:6px;background:color-mix(in oklab, var(--panel) 85%, transparent);border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:12px}
  .badge{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:999px;border:1px solid var(--line)}
  footer{grid-column:1/-1;text-align:center;color:var(--muted);font-size:12px;padding:4px 0}
  @media (max-width: 1000px){ .wrap{grid-template-columns:1fr} .style-panel{left:16px;right:16px;width:auto} }

  /* Measure controls (yellow) */
  .leaflet-control-measure {
    display: flex; gap: 8px; align-items: center; padding: 8px;
    border-radius: 14px; backdrop-filter: saturate(1.2) blur(6px);
    background: color-mix(in oklab, var(--panel) 75%, transparent);
    border: 1px solid var(--line); box-shadow: 0 6px 20px rgba(0,0,0,.15);
  }
  .leaflet-control-measure a {
    display: inline-flex !important; align-items: center; justify-content: center;
    width: 44px; height: 44px; padding: 0 !important; border-radius: 10px;
    border: 1px solid var(--measure-border); text-decoration: none;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
    transition: transform .08s ease, filter .15s ease, box-shadow .15s ease;
    background: var(--measure-bg); color: var(--measure-fg);
  }
  .leaflet-control-measure a:hover { filter: brightness(1.05); }
  .leaflet-control-measure a:active { transform: translateY(1px) scale(0.98); }
  .leaflet-control-measure a.active { outline: 2px solid var(--acc); }
  .leaflet-control-measure a .ico { display:flex; align-items:center; justify-content:center; font-size:20px; line-height:1; width:100%; height:100%; }
  :root { --measure-bg:#f5c518; --measure-border:#d4aa12; --measure-fg:#0b1020; }
  :root[data-theme="dark"] { --measure-bg:#ffd652; --measure-border:#e6bf2a; --measure-fg:#0b1020; }

  /* Ghost preview animation */
  .measure-ghost-line{ stroke-dasharray:6 6; animation: dash 1s linear infinite; }
  @keyframes dash{ to { stroke-dashoffset:-12; } }

  /* Theme toggle inverted look */
  #themeToggle { transition: filter .15s ease, background .15s ease, color .15s ease, border-color .15s ease; }
  :root[data-theme="light"] #themeToggle{ background:#0b1020 !important; color:#ffffff !important; border-color:#0b1020 !important; }
  :root[data-theme="dark"] #themeToggle{ background:#ffffff !important; color:#0b1020 !important; border-color:#ffffff !important; }

  /* Default popups (μη Identify) */
  :root[data-theme="light"] .leaflet-popup-content-wrapper,
  :root[data-theme="light"] .leaflet-popup-tip { background:#0b1020; color:#ffffff; border-color:#0b1020; }
  :root[data-theme="dark"] .leaflet-popup-content-wrapper,
  :root[data-theme="dark"] .leaflet-popup-tip { background:#ffffff; color:#0b1020; border-color:#ffffff; }
  .leaflet-popup-content { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial; }

  /* ---------- IDENTIFY POPUP (Excel-like) ---------- */
  :root[data-theme="light"] .identify-popup .leaflet-popup-content-wrapper,
  :root[data-theme="light"] .identify-popup .leaflet-popup-tip{
    background:#ffffff; color:#0b1020; border:1px solid #e6e8f2;
  }
  :root[data-theme="dark"] .identify-popup .leaflet-popup-content-wrapper,
  :root[data-theme="dark"] .identify-popup .leaflet-popup-tip{
    background:#0a0f1e; color:#e8ecff; border:1px solid #24324f;
  }
  .identify-popup .leaflet-popup-content{ margin:10px 12px; }
  .id-title{ font-weight:700; margin:0 0 8px 0; }
  .id-table{ width:100%; border-collapse:collapse; font-size:13px; }
  .id-table th, .id-table td{ padding:6px 8px; border:1px solid var(--line); vertical-align:top; }
  :root[data-theme="light"] .id-table thead th{ background:#f5f7ff; }
  :root[data-theme="dark"]  .id-table thead th{ background:#0b1228; color:#e8ecff; }
  .id-k{ color: var(--muted); width: 40%; }

  /* WINDOWS theme mirrors (attr/share) */
  :root[data-theme="dark"] .win{ background:#0f1630; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .win-header{ background:#0b1228; border-bottom-color:#24324f; }
  :root[data-theme="dark"] .win-toolbar{ background:rgba(255,255,255,0.03); border-bottom-color:#24324f; }
  :root[data-theme="dark"] .win-body{ background:#0a0f1e; }
  :root[data-theme="dark"] .icon-btn{ color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .icon-btn:hover{ border-color:#6aa6ff; }
  :root[data-theme="dark"] .btn{ background:#1a2448; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] .btn:hover{ border-color:#6aa6ff; }
  :root[data-theme="dark"] .win-toolbar input[type="search"]{ background:#0a0f1e; color:#e8ecff; border-color:#24324f; }
  :root[data-theme="dark"] thead th{ background:#0b1228; border-bottom-color:#24324f; }
  :root[data-theme="dark"] tbody td{ border-bottom-color:#19233d; }
  :root[data-theme="dark"] tbody tr:hover{ background:#0f1630; }

  :root[data-theme="light"] .win{ background:#ffffff; color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] .win-header{ background:#f5f7ff; border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] .win-toolbar{ background:rgba(0,0,0,0.02); border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] .win-body{ background:#ffffff; }
  :root[data-theme="light"] .icon-btn{ color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] .btn{ background:#f2f5ff; color:#0b1020; border-color:#e6e8f2; }
  :root[data-theme="light"] thead th{ background:#f5f7ff; border-bottom-color:#e6e8f2; }
  :root[data-theme="light"] tbody td{ border-bottom-color:#eef1f7; }
  :root[data-theme="light"] tbody tr:hover{ background:#f7f9ff; }

  /* ---- Top bar (Scale input + Lock + Measure) ---- */
  .topbar.leaflet-control{
    display:flex; gap:10px; align-items:center; padding:8px;
    border-radius:14px; background: color-mix(in oklab, var(--panel) 75%, transparent);
    border:1px solid var(--line); box-shadow:0 6px 20px rgba(0,0,0,.15);
  }
  .scalebox{
    display:flex; align-items:center; gap:6px; padding:6px 8px;
    border:1px solid var(--line); border-radius:10px; background: color-mix(in oklab, var(--panel) 85%, transparent);
  }
  .scalebox label{ font-size:12px; color:var(--muted); }
  #scaleInput{
    width:110px; padding:6px 8px; border-radius:8px; border:1px solid var(--line);
    background:var(--panel); color:var(--text); font-size:13px;
  }
  #scaleGo{
    padding:6px 10px; border-radius:8px; border:1px solid var(--line); cursor:pointer;
    background:var(--acc); color:#081226; font-weight:700;
  }
  #scaleLock{
    padding:6px 10px; border-radius:8px; border:1px solid var(--line); cursor:pointer;
    background:var(--panel); color:var(--text); font-weight:700;
  }
  #scaleLock.active{ outline:2px solid var(--acc); }

  /* Custom SCALE control box (graphic only) */
  .scale-control {
    background:#fff;
    color:#000;
    border:1px solid #000;
    border-radius:6px;
    padding:6px 8px;
    font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    box-shadow: 0 4px 14px rgba(0,0,0,.18);
    min-width: 120px;
  }
  .scale-row{ display:none; } /* 🔒 Κρύβει τα κείμενα πάνω από τη μπάρα */
  .scale-control .scale-graphic {
    position: relative;
    height: 8px;
    border:1px solid #000;
    margin-top:6px;
    background: linear-gradient(90deg, #000 0 50%, #fff 50% 100%);
  }
  .scale-control .scale-graphic::after{ content:''; position:absolute; inset:0; pointer-events:none; }
  .leaflet-bottom.leaflet-left { margin: 0 0 14px 14px; }

  /* HUD (live μέτρηση) δίπλα στον κέρσορα */
  #measureHud{
    position: absolute; pointer-events: none; z-index: 5000;
    transform: translate(12px, 12px);
    font: 12px/1.2 system-ui, -apple-system, Segoe UI, Roboto, Arial;
    padding: 6px 8px; border-radius: 8px; border: 1px solid var(--line);
    box-shadow: 0 6px 20px rgba(0,0,0,.22); display: none;
  }
  :root[data-theme="light"] #measureHud { background:#0b1020; color:#fff; border-color:#0b1020; }
  :root[data-theme="dark"]  #measureHud { background:#fff; color:#0b1020; border-color:#fff; }

  /* Windows should not steal map gestures */
  #attrwin, #sharewin { pointer-events: auto !important; z-index: 99999 !important; }
  #attrwin-header, #sharewin-header { cursor: move !important; pointer-events: auto !important; }
  #attrwin *, #sharewin * { user-select: auto !important; }
</style>
</head>
<body>
  <a class="skip-link" href="#map" style="position:absolute;left:-999px;top:auto;width:1px;height:1px;overflow:hidden" onfocus="this.style.left='12px';this.style.top='12px';this.style.width='auto';this.style.height='auto';">Παράβλεψη στο χάρτη</a>
  <div class="wrap">
    <header>
      <div class="brand"><div class="logo"></div><h1>GeoVisual Stories — Editor</h1></div>
      <div class="actions">
        <button id="themeToggle" type="button" class="btn" title="Theme: toggle light/dark" aria-pressed="false" aria-label="Switch theme">🌗 Theme</button>
        <button id="btnGenerate" type="button" class="btn primary" title="Δημιούργησε δημόσιο link για προβολή" aria-label="Generate public link">Generate Link</button>
      </div>
    </header>

    <aside class="sidebar">
      <div class="card">
        <h3>Στοιχεία Project</h3>
        <label>Τίτλος</label>
        <input id="title" type="text" placeholder="π.χ. Flood Risk — Thessaly 2025">
        <label>Περιγραφή</label>
        <textarea id="desc" placeholder="Σύντομη περιγραφή/μεθοδολογία..."></textarea>
      </div>

      <div class="card">
        <h3>Basemap</h3>
        <select id="basemap" title="Διάλεξε υπόβαθρο">
          <option value="osm">OpenStreetMap</option>
          <option value="sat">Satellite (Esri)</option>
          <option value="topo">Topographic (OpenTopoMap)</option>
        </select>
        <div class="muted" style="margin-top:6px">Διάλεξε υπόβαθρο</div>
      </div>

      <div class="card">
        <h3>Αρχεία</h3>
        <div id="drop" class="dropzone">
          Σύρε εδώ αρχεία ή <label style="text-decoration:underline;cursor:pointer">
            επίλεξε<input id="file" type="file" accept=",... (truncated)