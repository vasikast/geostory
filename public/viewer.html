<!DOCTYPE html>
<html lang="el" data-theme="auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GeoVisual Stories — Viewer</title>

<!-- Leaflet -->
<link rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""></script>

<style>
  :root{
    --bg:#f7f8fc; --panel:#ffffff; --card:#ffffff; --text:#0b1020;
    --muted:#5a678a; --line:#e6e8f2; --acc:#3b82f6; --acc2:#10b981;
  }
  :root[data-theme="dark"]{
    --bg:#0b1020; --panel:#0f1630; --card:#0d1430; --text:#e8ecff;
    --muted:#9fb0e0; --line:#24324f; --acc:#6aa6ff; --acc2:#00d3a7;
  }
  @media (prefers-color-scheme: dark){
    :root[data-theme="auto"]{
      --bg:#0b1020; --panel:#0f1630; --card:#0d1430; --text:#e8ecff;
      --muted:#9fb0e0; --line:#24324f; --acc:#6aa6ff; --acc2:#00d3a7;
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}

  header{
    display:flex;gap:8px;align-items:center;justify-content:flex-end;
    padding:8px 12px;background:var(--panel);border-bottom:1px solid var(--line)
  }
  .btn{background:#1a2448;border:1px solid #2b3c6a;color:#fff;padding:6px 10px;border-radius:10px;cursor:pointer}
  .btn:hover{filter:brightness(1.05)}

  .wrap{display:grid;grid-template-columns:360px 1fr;gap:12px;min-height:calc(100vh - 50px);padding:12px}
  .side{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:12px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  h2{margin:0 0 6px 0;font-size:18px}
  .desc{white-space:pre-wrap;color:var(--muted);font-size:14px}
  .layers{display:flex;flex-direction:column;gap:8px}
  .layer{
    background:color-mix(in oklab, var(--panel) 85%, transparent);
    border:1px solid var(--line);border-radius:12px;padding:8px 10px;font-size:13px;
    cursor:pointer; display:flex; align-items:center; justify-content:space-between;
  }
  .layer.active{ outline:2px solid var(--acc); }
  .canvas{border:1px solid var(--line);border-radius:16px;overflow:hidden}
  #map{height:100%;min-height:70vh;background:#0a0f1e}

  /* Leaflet controls */
  .leaflet-control-attribution,
  .leaflet-control-scale-line,
  .leaflet-bar a, .leaflet-bar a:hover{
    background: color-mix(in oklab, var(--panel) 85%, transparent);
    color: var(--muted);
    border-color: var(--line);
  }
  .leaflet-bar a{ color: var(--text); }

  @media (max-width: 900px){ .wrap{grid-template-columns:1fr} }
</style>

<!-- Attribute Window styles (cache-bust) -->
<link rel="stylesheet" href="/public/css/attrwin.css?v=3" />
</head>
<body>
  <header>
    <button id="themeToggle" class="btn" title="Theme">🌗 Theme</button>
    <button id="openTable" class="btn" title="Attributes">🧾 Attributes</button>
  </header>

  <div class="wrap">
    <aside class="side">
      <div class="card">
        <h2 id="title">Φόρτωση…</h2>
        <div id="desc" class="desc"></div>
      </div>
      <div class="card">
        <h3 style="margin:0 0 6px 0;font-size:14px">Στρώσεις</h3>
        <div id="layerList" class="layers"></div>
      </div>
    </aside>
    <section class="canvas"><div id="map"></div></section>
  </div>

  <!-- Attribute Table Window (draggable/resizable/min/max/close) -->
  <div id="attrwin" class="win hidden" role="dialog" aria-label="Attribute table" aria-modal="false">
    <div class="win-header" id="attrwin-header">
      <div class="win-title"><span id="attrwin-title">Attribute Table</span></div>
      <div class="win-actions">
        <button class="icon-btn" id="attrwin-min" title="Minimize" aria-label="Minimize">—</button>
        <button class="icon-btn" id="attrwin-max" title="Maximize/Restore" aria-label="Maximize">⬜</button>
        <button class="icon-btn danger" id="attrwin-close" title="Close" aria-label="Close">✕</button>
      </div>
    </div>
    <div class="win-toolbar">
      <input id="attrwin-search" type="search" placeholder="Αναζήτηση…" />
      <button id="attrwin-csv" class="btn btn-sm">Export CSV</button>
      <span id="attrwin-count" class="muted"></span>
    </div>
    <div class="win-body">
      <table id="attrwin-table">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="win-resize-handle" id="attrwin-resize" aria-hidden="true"></div>
  </div>

  <!-- Attribute Window logic (cache-bust) -->
  <script type="module" src="/public/js/attrwin.js?v=3"></script>

  <!-- Viewer logic -->
  <script type="module">
    import { openAttrWindow, setAttrData } from '/public/js/attrwin.js?v=3';

    // THEME TOGGLE
    (function(){
      const root = document.documentElement;
      const KEY = 'geostory-theme';
      const btn = document.getElementById('themeToggle');
      const saved = localStorage.getItem(KEY);
      if(saved){ root.setAttribute('data-theme', saved); }
      function label(){ btn.title = `Theme: ${root.getAttribute('data-theme') || 'auto'}`; }
      label();
      btn.addEventListener('click', ()=>{
        const cur = root.getAttribute('data-theme') || 'auto';
        const next = cur === 'auto' ? 'light' : cur === 'light' ? 'dark' : 'auto';
        root.setAttribute('data-theme', next);
        localStorage.setItem(KEY, next);
        label();
      });
    })();

    // Φόρτωση story
    const storyId = location.pathname.split('/').pop();
    const res = await fetch('/api/stories/'+storyId);
    if(!res.ok){
      document.body.innerHTML='<p style="padding:20px">Το project δεν βρέθηκε ή έχει λήξει.</p>';
      throw new Error('Story not found');
    }
    const { state } = await res.json();

    // UI
    document.getElementById('title').textContent = state.title || 'Untitled';
    document.getElementById('desc').textContent = state.description || '';

    // Χάρτης
    const basemaps = {
      osm: L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}),
      sat: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Esri'}),
      topo:L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'&copy; OpenTopoMap'})
    };
    const map = L.map('map');
    (basemaps[state.basemap||'osm']).addTo(map);
    map.setView([state.center.lat,state.center.lng], state.zoom||6);

    function styleFrom(layer){
      const st = layer.style || {};
      const renderer = st.renderer || 'single';
      if(renderer==='single'){
        const s=st.single || {};
        return (feature)=>({
          color: s.stroke || '#4cc9f0',
          weight: s.width ?? 2,
          fillColor: s.fill || '#4361ee',
          fillOpacity: layer.kind==='line'?0 : (s.opacity ?? 0.75)
        });
      } else if(renderer==='unique' && st.unique?.field){
        const items = st.unique.legend||[];
        return (feature)=>{
          const v = String(feature.properties?.[st.unique.field]);
          const it = items.find(x=> String(x.value)===v);
          const color = it ? it.color : '#999';
          return { color, weight:2, fillColor:color, fillOpacity: layer.kind==='line'?0 : 0.6 };
        };
      } else if(renderer==='graduated' && st.graduated?.field){
        const br = st.graduated.breaks||[];
        const cols = (st.graduated.legend||[]).map(x=>x.color);
        return (feature)=>{
          const val = Number(feature.properties?.[st.graduated.field]);
          let idx = br.findIndex(b => val <= b);
          if(idx<0) idx = cols.length-1;
          const color = cols[idx] || '#999';
          return { color, weight:2, fillColor:color, fillOpacity: layer.kind==='line'?0 : 0.6 };
        };
      }
      return ()=>({ color:'#4cc9f0', weight:2, fillColor:'#4361ee', fillOpacity:0.6 });
    }

    const layerListEl=document.getElementById('layerList');
    const uiLayers = [];

    (state.layers||[]).forEach((LY, idx)=>{
      const styleFn = styleFrom(LY);
      const g=L.geoJSON(LY.gj,{ style: styleFn });
      if(LY.visible!==false) g.addTo(map);
      try{ if(idx===0) map.fitBounds(g.getBounds(),{padding:[20,20]}); }catch(_){}
      const row=document.createElement('div');
      row.className='layer' + (idx===0?' active':'');
      row.textContent=LY.name||'Layer';
      row.addEventListener('click', ()=>{
        uiLayers.forEach((L2,i)=> L2.rowEl.classList.toggle('active', i===idx));
      });
      layerListEl.appendChild(row);
      uiLayers.push({ name: LY.name||'Layer', gj: LY.gj, rowEl: row });
    });

    function getActiveIndex(){
      return uiLayers.findIndex(L => L.rowEl.classList.contains('active'));
    }

    // ✅ ΑΝΟΙΓΕΙ ΠΑΝΤΑ (fallback στο 1ο layer αν δεν υπάρχει active)
    document.getElementById('openTable').addEventListener('click', ()=>{
      let ai = getActiveIndex();
      if (ai < 0) ai = 0;
      const LAYER = uiLayers[ai];
      if (!LAYER) return;
      const feats = (LAYER.gj?.features||[]);
      const rows = feats.map((f,i)=>({ id: f.id ?? (i+1), ...f.properties }));
      openAttrWindow(rows, { title: `Attributes • ${LAYER.name}` });
    });
  </script>
</body>
</html>
